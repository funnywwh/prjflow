# 微信域名验证文件配置指南

## 概述

微信公众平台在配置"网页授权域名"时，需要验证域名所有权。验证方式是将验证文件上传到服务器根目录，并确保可以通过HTTP访问。

## 验证文件格式

验证文件名格式：`MP_verify_xxxxx.txt`

例如：`MP_verify_xJWzw9UUmpBJxEok.txt`

## 配置方式

### 方式1：通过API上传（推荐）

系统提供了API接口，可以直接上传验证文件内容，无需手动上传文件到服务器。

**API接口**：`POST /api/wechat/verify-file`

**请求示例**：

```bash
curl -X POST http://localhost:8080/api/wechat/verify-file \
  -H "Content-Type: application/json" \
  -d '{
    "filename": "MP_verify_xJWzw9UUmpBJxEok.txt",
    "content": "xJWzw9UUmpBJxEok"
  }'
```

**响应示例**：

```json
{
  "message": "验证文件保存成功",
  "filename": "MP_verify_xJWzw9UUmpBJxEok.txt",
  "url": "/MP_verify_xJWzw9UUmpBJxEok.txt"
}
```

### 方式2：手动上传文件（传统方式）

1. 下载微信提供的验证文件（如 `MP_verify_xJWzw9UUmpBJxEok.txt`）
2. 将文件上传到服务器根目录
3. 确保文件可以通过HTTP访问：`http://yourdomain.com/MP_verify_xJWzw9UUmpBJxEok.txt`

## 验证文件访问

配置完成后，验证文件可以通过以下URL访问：

- 开发环境：`http://localhost:8080/MP_verify_xxxxx.txt`
- 生产环境：`https://yourdomain.com/MP_verify_xxxxx.txt`

## 配置步骤

### 1. 获取验证文件信息

在微信公众平台配置"网页授权域名"时，系统会提供：
- 验证文件名（如：`MP_verify_xJWzw9UUmpBJxEok.txt`）
- 文件内容（通常就是验证码，如：`xJWzw9UUmpBJxEok`）

### 2. 上传验证文件

**使用API上传（推荐）**：

```bash
# 使用curl
curl -X POST http://localhost:8080/api/wechat/verify-file \
  -H "Content-Type: application/json" \
  -d '{
    "filename": "MP_verify_xJWzw9UUmpBJxEok.txt",
    "content": "xJWzw9UUmpBJxEok"
  }'
```

**或使用前端界面**（如果已实现）：

在系统管理界面中，找到"微信配置" > "域名验证"，输入文件名和内容，点击保存。

### 3. 验证文件可访问性

访问验证文件URL，确认可以正常访问：

```bash
curl http://localhost:8080/MP_verify_xJWzw9UUmpBJxEok.txt
```

应该返回文件内容（验证码）。

### 4. 在微信公众平台完成验证

1. 返回微信公众平台
2. 点击"验证"按钮
3. 微信会访问验证文件URL
4. 如果文件内容正确，验证通过

## 注意事项

1. **文件路径**：验证文件必须放在域名根目录，即 `http://yourdomain.com/MP_verify_xxxxx.txt`
2. **文件内容**：文件内容必须与微信提供的完全一致（通常是验证码）
3. **访问权限**：验证文件必须可以通过HTTP公开访问，不需要认证
4. **文件格式**：文件必须是纯文本格式（.txt），内容就是验证码本身
5. **HTTPS**：生产环境建议使用HTTPS，但HTTP也可以用于验证

## 故障排查

### 问题1：404 Not Found

**原因**：验证文件未上传或路径不正确

**解决方案**：
1. 检查文件是否已通过API上传
2. 检查URL路径是否正确（必须是根路径）
3. 检查路由配置是否正确

### 问题2：文件内容不正确

**原因**：文件内容与微信提供的不一致

**解决方案**：
1. 重新获取微信提供的验证文件内容
2. 通过API重新上传正确的文件内容

### 问题3：验证超时

**原因**：微信无法访问验证文件URL

**解决方案**：
1. 确保服务器可以公网访问（开发环境需要使用内网穿透）
2. 检查防火墙设置
3. 确保域名已正确解析

## 技术实现

系统将验证文件内容存储在数据库中（`SystemConfig`表），通过路由 `/MP_verify_:code.txt` 提供HTTP访问。

**存储格式**：
- Key: `wechat_verify_file_MP_verify_xxxxx.txt`
- Value: 验证文件内容（验证码）
- Type: `string`

**访问路由**：
- 路由：`GET /MP_verify_:code.txt`
- 处理：从数据库读取文件内容并返回

## 相关文档

- [微信登录配置指南](./微信登录配置指南.md)
- [API设计文档](./API设计文档.md)

