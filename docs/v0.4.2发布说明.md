# v0.4.2 发布说明

**发布日期**: 2025年1月XX日

## 版本概述

v0.4.2 版本主要修复了微信绑定功能的多个问题，包括支持公众号配置、修复软删除用户绑定问题，以及改进错误处理和配置管理。

## 主要更新

### 1. 微信绑定功能修复 🔧

#### 修复获取 access_token 失败问题
- **问题**：用户绑定微信和管理员扫码添加用户时，获取 access_token 失败
- **原因**：未正确设置 `AccountType` 和 `Scope` 参数
- **修复**：
  - 在所有微信相关操作中正确设置 `AccountType` 和 `Scope`
  - 支持从数据库读取配置（优先数据库，其次配置文件）
  - 添加配置值清理（去除首尾空格）

#### 支持公众号配置 ✨
- **新增功能**：支持在系统设置中配置账号类型（公众号/开放平台）
- **配置选项**：
  - 账号类型：开放平台网站应用 / 公众号
  - 授权范围：静默授权 / 需要用户确认（仅公众号）
- **配置优先级**：数据库配置 > 配置文件 > 默认值
- **前端界面**：在微信设置页面添加账号类型和授权范围选择

#### 修复软删除用户绑定问题 🔧
- **问题**：删除用户后，该用户的微信 OpenID 仍然占用唯一约束，导致无法重新绑定
- **修复**：
  - 绑定前检查包括软删除的用户
  - 自动清理已删除用户的微信绑定
  - 改进错误处理，提供更友好的错误提示

### 2. 错误处理改进 📈

- **详细错误信息**：添加更详细的错误提示，包括实际使用的配置值
- **调试信息**：在获取 access_token 时显示配置信息（AppSecret 部分隐藏）
- **错误码处理**：添加对 `invalid appsecret` 错误的专门处理
- **配置验证**：改进配置读取的错误检查，确保配置不为空

### 3. 配置管理优化 🔧

- **配置读取**：所有配置读取都添加了 TrimSpace 处理，去除首尾空格
- **配置验证**：添加配置值验证，确保 AppID 和 AppSecret 不为空
- **配置回退**：支持从配置文件回退，如果数据库中没有配置

## 技术实现

### 后端修改

1. **配置读取优化**
   - `ProcessWeChatCallback`：支持从数据库读取 account_type 和 scope
   - `GetQRCode`、`WeChatLogin`、`GetWeChatBindQRCode`：添加配置设置
   - 所有配置读取都添加了 TrimSpace 和错误检查

2. **软删除处理**
   - `BindCallbackHandler.Process`：使用 `Unscoped()` 查询包括软删除的用户
   - 自动清理已删除用户的 `wechat_open_id`
   - 改进唯一约束错误的处理

3. **错误处理**
   - `GetAccessToken`：添加对 40013 错误码的处理
   - 添加调试信息输出（AppSecret 部分隐藏）
   - 改进错误消息的详细程度

4. **配置保存**
   - `SaveWeChatConfig`：支持保存 account_type 和 scope 到数据库
   - `GetWeChatConfig`：返回 account_type 和 scope 配置

### 前端修改

1. **微信设置页面**
   - 添加账号类型选择（开放平台网站应用 / 公众号）
   - 添加授权范围选择（仅当选择公众号时显示）
   - 保存时同时保存 account_type 和 scope

2. **API 接口**
   - `WeChatConfig` 接口添加 `account_type` 和 `scope` 字段
   - `WeChatConfigRequest` 接口添加可选字段

## 使用指南

### 配置公众号

1. 打开系统设置 → 微信设置
2. 填写 AppID 和 AppSecret（公众号的）
3. 在"账号类型"中选择"公众号"
4. 在"授权范围"中选择"需要用户确认（可获取用户信息）"（推荐）
5. 点击"保存配置"

### 绑定微信

1. 点击右上角用户菜单 → 绑定微信
2. 使用微信扫码
3. 在微信内确认授权
4. 返回 PC 端查看绑定结果

### 解绑微信

1. 点击右上角用户菜单 → 解绑微信
2. 确认解绑操作

## 更新内容

### 修改文件

**后端**：
- `backend/internal/api/auth.go` - 修复绑定逻辑，添加软删除处理
- `backend/internal/api/wechat_callback.go` - 支持从数据库读取配置
- `backend/internal/api/wechat.go` - 支持保存和读取 account_type 和 scope
- `backend/internal/api/init.go` - 修复配置读取
- `backend/pkg/wechat/client.go` - 改进错误处理

**前端**：
- `frontend/src/views/system/WeChatSettings.vue` - 添加账号类型和授权范围选择
- `frontend/src/api/wechat.ts` - 更新接口定义

## 已知问题

无

## 后续计划

- 继续完善单元测试覆盖率
- 优化微信绑定流程的用户体验
- 支持更多微信相关功能

## 升级指南

### 从 v0.4.1 升级

1. **代码更新**：拉取最新代码
2. **配置更新**：在系统设置中重新保存微信配置，选择正确的账号类型
3. **测试验证**：测试微信绑定和解绑功能

### 注意事项

- 如果使用公众号，必须在系统设置中选择"公众号"类型
- 确保微信后台配置的授权回调域名正确
- 如果之前有软删除的用户占用了微信绑定，系统会自动清理

## 致谢

感谢所有贡献者的支持和反馈！

---

**下载地址**: [GitHub Releases](https://github.com/funnywwh/goproject/releases/tag/v0.4.2)

