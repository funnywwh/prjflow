# v0.4.13 发布说明

**发布日期**: 2025年12月02日

## 版本概述

v0.4.13 版本主要修复了Bug编辑功能中的关键问题，完善了历史记录功能，提升了用户体验。本次更新包括Bug编辑时清空关联需求/模块的功能修复、历史记录显示优化以及字段变更记录的完善。

## 主要更新

### 1. Bug编辑功能修复 🔧

#### 修复内容
- **修复清空关联需求/模块不生效的问题**：当用户点击下拉框的关闭按钮清空关联需求或模块时，现在可以正确清空并保存
- **确保字段始终发送**：修复了 `requirement_id` 和 `module_id` 字段在某些情况下不发送到服务器的问题
- **修复字段更新冲突**：解决了在更新实际工时时，关联需求、关联模块等字段的修改被覆盖的问题

#### 技术实现
- 前端确保 `requirement_id` 和 `module_id` 字段始终被包含在请求中，即使值为 `0`（清空时）
- 后端正确处理 `0` 值，将其转换为 `nil` 以清空关联
- 修复了 `oldBug` 深拷贝问题，确保历史记录正确比较指针字段

### 2. 历史记录功能完善 📝

#### 功能增强
- **完善字段变更记录**：确保所有字段修改（`project_id`、`requirement_id`、`module_id`、`resolved_version_id` 等）都记录到历史记录中
- **优化显示格式**：历史记录中的"旧值"和"新值"现在分行显示，提高可读性
- **字段名称转换**：历史记录中显示项目名称、需求标题、模块名称等可读性信息，而非ID

#### 显示优化
- 旧值和新值分行显示，格式更清晰
- 字段名称使用中文显示（如"项目"、"关联需求"、"功能模块"等）
- 关联对象显示为名称而非ID（如项目名称、需求标题、版本号等）

### 3. 代码质量改进 🛠️

#### 改进内容
- 修复了 `oldBug` 对象的深拷贝问题，避免指针共享导致的比较错误
- 优化了前端数据发送逻辑，确保关键字段始终被包含
- 完善了字段变更检测逻辑，确保所有相关字段的修改都被记录

## 技术细节

### 前端修改
- `frontend/src/api/bug.ts`：确保 `requirement_id` 和 `module_id` 字段始终发送
- `frontend/src/views/bug/BugDetail.vue`：修复清空关联需求/模块的逻辑
- 所有历史记录显示组件：优化显示格式，旧值和新值分行显示

### 后端修改
- `backend/internal/api/bug.go`：
  - 修复 `oldBug` 深拷贝问题
  - 正确处理 `requirement_id` 和 `module_id` 的 `0` 值
  - 确保字段更新时不会相互覆盖
- `backend/internal/utils/action.go`：
  - 完善字段变更检测逻辑
  - 添加字段显示名称转换函数
  - 优化历史记录处理逻辑

## 修复的问题

1. ✅ 修复编辑Bug时清空关联需求不生效的问题
2. ✅ 修复编辑Bug时清空关联模块不生效的问题
3. ✅ 修复更新实际工时时，关联需求/模块的修改被覆盖的问题
4. ✅ 修复历史记录中某些字段变更未被记录的问题
5. ✅ 优化历史记录显示格式，提高可读性

## 升级说明

### 从 v0.4.12 升级

1. **无需数据库迁移**：本次更新不涉及数据库结构变更
2. **前端更新**：需要重新构建前端，更新相关组件
3. **后端更新**：需要重新编译后端，更新相关API处理逻辑

### 注意事项

- 历史记录显示格式已优化，旧的历史记录会以新格式显示
- 清空关联需求/模块的功能现在可以正常工作
- 所有字段的修改都会正确记录到历史记录中

## 测试建议

1. **Bug编辑测试**：
   - 测试编辑Bug时清空关联需求
   - 测试编辑Bug时清空关联模块
   - 测试同时更新实际工时和关联需求/模块

2. **历史记录测试**：
   - 验证所有字段修改都被记录
   - 验证历史记录显示格式正确
   - 验证字段名称显示为中文

## 后续计划

- 继续优化历史记录功能
- 完善其他模块的字段变更记录
- 提升整体用户体验

---

**版本号**: v0.4.13  
**发布日期**: 2025年12月02日  
**兼容性**: 向后兼容 v0.4.12

