# 资源管理详细设计文档

## 1. 概述

资源管理系统用于管理项目的人员资源分配，跟踪资源使用情况，记录工时分配，检测资源冲突，分析资源利用率。系统支持资源创建、更新、删除，资源分配管理，资源统计，资源冲突检测，以及资源利用率分析。

## 2. 功能特性

### 2.1 资源管理

- **资源CRUD**：创建、查看、更新、删除人员资源
- **资源关联**：资源关联用户和项目
- **资源角色**：支持设置资源在项目中的角色
- **资源筛选**：支持按用户、项目、角色筛选资源

### 2.2 资源分配管理

- **资源分配CRUD**：创建、查看、更新、删除资源分配
- **工时记录**：按小时记录资源分配，支持关联任务、Bug、需求、项目
- **日期管理**：支持按日期记录资源分配
- **工作描述**：支持记录工作描述
- **资源分配筛选**：支持按资源、用户、项目、任务、Bug、日期范围筛选

### 2.3 资源统计

- **总体统计**：统计总工时、按项目统计、按人员统计
- **工时分类**：按任务、Bug、需求分类统计工时
- **时间范围统计**：支持按时间范围统计工时

### 2.4 资源冲突检测

- **冲突检测**：检测同一人员在同一天的工时是否超过限制
- **冲突预警**：当工时超过12小时时发出警告，超过24小时时标记为冲突
- **冲突详情**：显示冲突的详细分配情况

### 2.5 资源利用率分析

- **利用率计算**：计算资源利用率（实际工时 / 最大可能工时 * 100）
- **按资源统计**：按资源统计利用率
- **平均利用率**：计算平均利用率
- **时间范围分析**：支持按时间范围分析利用率

### 2.6 资源日历

- **日历视图**：按日期分组显示资源分配
- **日期范围筛选**：支持按日期范围筛选
- **用户和项目筛选**：支持按用户和项目筛选

## 3. 数据模型

### 3.1 资源表（resources）

```go
type Resource struct {
    ID        uint           `gorm:"primarykey" json:"id"`
    CreatedAt time.Time      `json:"created_at"`
    UpdatedAt time.Time      `json:"updated_at"`
    DeletedAt gorm.DeletedAt `gorm:"index" json:"-"`

    UserID uint `gorm:"index;not null" json:"user_id"`
    User   User `gorm:"foreignKey:UserID" json:"user,omitempty"`

    ProjectID uint    `gorm:"index;not null" json:"project_id"`
    Project   Project `gorm:"foreignKey:ProjectID" json:"project,omitempty"`

    Role string `gorm:"size:50" json:"role"` // 资源角色

    Allocations []ResourceAllocation `gorm:"foreignKey:ResourceID" json:"allocations,omitempty"`
}
```

**字段说明：**

- `UserID`：用户ID，必填，关联用户表
- `ProjectID`：项目ID，必填，关联项目表
- `Role`：资源角色，可选，用于标识资源在项目中的角色（如：开发、测试、产品等）
- `Allocations`：资源分配列表

**唯一性约束：**

- 同一用户在同一项目中只能有一个资源记录（通过应用层保证）

### 3.2 资源分配表（resource_allocations）

```go
type ResourceAllocation struct {
    ID        uint           `gorm:"primarykey" json:"id"`
    CreatedAt time.Time      `json:"created_at"`
    UpdatedAt time.Time      `json:"updated_at"`
    DeletedAt gorm.DeletedAt `gorm:"index" json:"-"`

    ResourceID uint     `gorm:"index;not null" json:"resource_id"`
    Resource   Resource `gorm:"foreignKey:ResourceID" json:"resource,omitempty"`

    Date     time.Time `gorm:"type:date;not null" json:"date"`     // 日期
    Hours    float64   `gorm:"not null" json:"hours"`              // 小时数
    TaskID   *uint     `gorm:"index" json:"task_id"`               // 可选关联任务
    Task     *Task     `gorm:"foreignKey:TaskID" json:"task,omitempty"`
    BugID    *uint     `gorm:"index" json:"bug_id"`                // 可选关联Bug
    Bug      *Bug      `gorm:"foreignKey:BugID" json:"bug,omitempty"`
    RequirementID *uint     `gorm:"index" json:"requirement_id"`   // 可选关联需求
    Requirement   *Requirement `gorm:"foreignKey:RequirementID" json:"requirement,omitempty"`
    ProjectID *uint    `gorm:"index" json:"project_id"`           // 可选关联项目
    Project   *Project `gorm:"foreignKey:ProjectID" json:"project,omitempty"`

    Description string `gorm:"type:text" json:"description"` // 工作描述
}
```

**字段说明：**

- `ResourceID`：资源ID，必填，关联资源表
- `Date`：日期，必填，资源分配的日期
- `Hours`：小时数，必填，必须大于0
- `TaskID`：任务ID，可选，关联任务表
- `BugID`：BugID，可选，关联Bug表
- `RequirementID`：需求ID，可选，关联需求表
- `ProjectID`：项目ID，可选，关联项目表
- `Description`：工作描述，可选，用于描述工作内容

**约束：**

- 同一资源在同一天的总工时不能超过24小时（通过应用层检查）

## 4. API设计

### 4.1 资源管理API

#### 4.1.1 获取资源列表

**接口：** `GET /api/resources`

**权限：** `resource:read`

**查询参数：**

- `user_id`：用户ID
- `project_id`：项目ID
- `role`：资源角色
- `page`：页码，默认1
- `size`：每页数量，默认10

**响应示例：**

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "user_id": 1,
        "user": {
          "id": 1,
          "username": "user1",
          "nickname": "用户1"
        },
        "project_id": 1,
        "project": {
          "id": 1,
          "name": "项目名称"
        },
        "role": "开发",
        "created_at": "2024-01-01T00:00:00Z",
        "updated_at": "2024-01-01T00:00:00Z"
      }
    ],
    "total": 50,
    "page": 1,
    "page_size": 10
  }
}
```

#### 4.1.2 获取资源详情

**接口：** `GET /api/resources/:id`

**权限：** `resource:read`

**响应示例：**

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "user_id": 1,
    "user": {
      "id": 1,
      "username": "user1",
      "nickname": "用户1"
    },
    "project_id": 1,
    "project": {
      "id": 1,
      "name": "项目名称",
      "code": "PROJECT001"
    },
    "role": "开发",
    "allocations": [
      {
        "id": 1,
        "date": "2024-01-01",
        "hours": 8.0,
        "task_id": 1,
        "description": "开发任务1"
      }
    ],
    "created_at": "2024-01-01T00:00:00Z",
    "updated_at": "2024-01-01T00:00:00Z"
  }
}
```

#### 4.1.3 创建资源

**接口：** `POST /api/resources`

**权限：** `resource:create`

**请求体：**

```json
{
  "user_id": 1,
  "project_id": 1,
  "role": "开发"
}
```

**字段说明：**

- `user_id`：用户ID，必填
- `project_id`：项目ID，必填
- `role`：资源角色，可选

**响应示例：**

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "user_id": 1,
    "user": {
      "id": 1,
      "username": "user1",
      "nickname": "用户1"
    },
    "project_id": 1,
    "project": {
      "id": 1,
      "name": "项目名称"
    },
    "role": "开发",
    "created_at": "2024-01-01T00:00:00Z",
    "updated_at": "2024-01-01T00:00:00Z"
  }
}
```

#### 4.1.4 更新资源

**接口：** `PUT /api/resources/:id`

**权限：** `resource:update`

**请求体：**

```json
{
  "role": "测试"
}
```

#### 4.1.5 删除资源

**接口：** `DELETE /api/resources/:id`

**权限：** `resource:delete`

### 4.2 资源分配管理API

#### 4.2.1 获取资源分配列表

**接口：** `GET /api/resource-allocations`

**权限：** `resource-allocation:read`

**查询参数：**

- `resource_id`：资源ID
- `user_id`：用户ID（通过资源）
- `project_id`：项目ID
- `task_id`：任务ID
- `bug_id`：BugID
- `start_date`：开始日期（YYYY-MM-DD）
- `end_date`：结束日期（YYYY-MM-DD）
- `page`：页码，默认1
- `size`：每页数量，默认10

**响应示例：**

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "resource_id": 1,
        "resource": {
          "id": 1,
          "user": {
            "id": 1,
            "username": "user1",
            "nickname": "用户1"
          },
          "project": {
            "id": 1,
            "name": "项目名称"
          }
        },
        "date": "2024-01-01",
        "hours": 8.0,
        "task_id": 1,
        "task": {
          "id": 1,
          "title": "任务1"
        },
        "bug_id": null,
        "requirement_id": null,
        "project_id": 1,
        "project": {
          "id": 1,
          "name": "项目名称"
        },
        "description": "开发任务1",
        "created_at": "2024-01-01T00:00:00Z",
        "updated_at": "2024-01-01T00:00:00Z"
      }
    ],
    "total": 100,
    "page": 1,
    "page_size": 10
  }
}
```

#### 4.2.2 获取资源分配详情

**接口：** `GET /api/resource-allocations/:id`

**权限：** `resource-allocation:read`

#### 4.2.3 创建资源分配

**接口：** `POST /api/resource-allocations`

**权限：** `resource-allocation:create`

**请求体：**

```json
{
  "resource_id": 1,
  "date": "2024-01-01",
  "hours": 8.0,
  "task_id": 1,
  "project_id": 1,
  "description": "开发任务1"
}
```

**字段说明：**

- `resource_id`：资源ID，必填
- `date`：日期，必填，格式为"YYYY-MM-DD"
- `hours`：小时数，必填，必须大于0
- `task_id`：任务ID，可选
- `bug_id`：BugID，可选
- `requirement_id`：需求ID，可选
- `project_id`：项目ID，可选
- `description`：工作描述，可选

**约束检查：**

- 同一资源在同一天的总工时不能超过24小时
- 如果超过24小时，返回错误："该资源在指定日期的总工时不能超过24小时"

#### 4.2.4 更新资源分配

**接口：** `PUT /api/resource-allocations/:id`

**权限：** `resource-allocation:update`

**请求体：**

```json
{
  "date": "2024-01-02",
  "hours": 6.0,
  "task_id": 2,
  "description": "更新后的工作描述"
}
```

**约束检查：**

- 更新时同样检查同一资源在同一天的总工时不能超过24小时（排除当前记录）

#### 4.2.5 删除资源分配

**接口：** `DELETE /api/resource-allocations/:id`

**权限：** `resource-allocation:delete`

#### 4.2.6 获取资源日历

**接口：** `GET /api/resource-allocations/calendar`

**权限：** `resource-allocation:read`

**查询参数：**

- `user_id`：用户ID
- `project_id`：项目ID
- `start_date`：开始日期（YYYY-MM-DD），默认当前月份第一天
- `end_date`：结束日期（YYYY-MM-DD），默认当前月份最后一天

**响应示例：**

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "start_date": "2024-01-01",
    "end_date": "2024-01-31",
    "data": {
      "2024-01-01": [
        {
          "id": 1,
          "resource_id": 1,
          "date": "2024-01-01",
          "hours": 8.0,
          "task_id": 1,
          "description": "开发任务1"
        }
      ],
      "2024-01-02": [
        {
          "id": 2,
          "resource_id": 1,
          "date": "2024-01-02",
          "hours": 6.0,
          "task_id": 2,
          "description": "开发任务2"
        }
      ]
    }
  }
}
```

#### 4.2.7 检查资源冲突（基于resource_id）

**接口：** `GET /api/resource-allocations/conflict`

**权限：** `resource-allocation:read`

**查询参数：**

- `resource_id`：资源ID，必填
- `date`：日期（YYYY-MM-DD），必填

**响应示例：**

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "resource_id": "1",
    "date": "2024-01-01",
    "total_hours": 25.0,
    "conflicts": [
      "总工时超过24小时"
    ],
    "has_conflict": true,
    "has_warning": true,
    "allocations": [
      {
        "project_name": "项目1",
        "task_title": "任务1",
        "bug_title": null,
        "hours": 8.0,
        "description": "开发任务1"
      },
      {
        "project_name": "项目2",
        "task_title": "任务2",
        "bug_title": null,
        "hours": 17.0,
        "description": "开发任务2"
      }
    ]
  }
}
```

### 4.3 资源统计API

#### 4.3.1 获取资源统计

**接口：** `GET /api/resources/statistics`

**权限：** `resource:read`

**查询参数：**

- `user_id`：用户ID（可选）
- `project_id`：项目ID（可选）

**响应示例：**

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total_hours": 1000.0,
    "project_stats": [
      {
        "project_id": 1,
        "project_name": "项目1",
        "total_hours": 500.0
      },
      {
        "project_id": 2,
        "project_name": "项目2",
        "total_hours": 500.0
      }
    ],
    "user_stats": [
      {
        "user_id": 1,
        "username": "user1",
        "nickname": "用户1",
        "total_hours": 300.0
      },
      {
        "user_id": 2,
        "username": "user2",
        "nickname": "用户2",
        "total_hours": 200.0
      }
    ]
  }
}
```

**统计说明：**

- `total_hours`：总工时（从ResourceAllocation表统计）
- `project_stats`：按项目统计工时
- `user_stats`：按人员统计工时

**工时分类：**

- 任务工时：关联任务的资源分配工时
- Bug工时：关联Bug的资源分配工时
- 需求工时：关联需求的资源分配工时

### 4.4 资源冲突检测API

#### 4.4.1 检查资源冲突（基于user_id）

**接口：** `GET /api/resources/conflict`

**权限：** `resource:read`

**查询参数：**

- `user_id`：用户ID，必填
- `date`：日期（YYYY-MM-DD），必填

**响应示例：**

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "user_id": "1",
    "date": "2024-01-01",
    "total_hours": 25.0,
    "conflicts": [
      "总工时超过24小时",
      "总工时超过12小时（建议检查）"
    ],
    "has_conflict": true,
    "has_warning": true,
    "allocations": [
      {
        "project_name": "项目1",
        "task_title": "任务1",
        "bug_title": null,
        "hours": 8.0,
        "description": "开发任务1"
      },
      {
        "project_name": "项目2",
        "task_title": "任务2",
        "bug_title": null,
        "hours": 17.0,
        "description": "开发任务2"
      }
    ]
  }
}
```

**冲突规则：**

- `has_conflict`：总工时超过24小时时为true
- `has_warning`：总工时超过12小时时为true
- `conflicts`：冲突描述列表

### 4.5 资源利用率分析API

#### 4.5.1 获取资源利用率

**接口：** `GET /api/resources/utilization`

**权限：** `resource:read`

**查询参数：**

- `user_id`：用户ID（可选）
- `project_id`：项目ID（可选）
- `start_date`：开始日期（YYYY-MM-DD），默认当前月份第一天
- `end_date`：结束日期（YYYY-MM-DD），默认当前月份最后一天

**响应示例：**

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "start_date": "2024-01-01",
    "end_date": "2024-01-31",
    "days": 31,
    "utilization_stats": [
      {
        "resource_id": 1,
        "user_id": 1,
        "username": "user1",
        "nickname": "用户1",
        "project_id": 1,
        "project_name": "项目1",
        "total_hours": 160.0,
        "max_hours": 744.0,
        "utilization": 21.5
      },
      {
        "resource_id": 2,
        "user_id": 2,
        "username": "user2",
        "nickname": "用户2",
        "project_id": 1,
        "project_name": "项目1",
        "total_hours": 120.0,
        "max_hours": 744.0,
        "utilization": 16.1
      }
    ],
    "avg_utilization": 18.8
  }
}
```

**利用率计算：**

- `max_hours`：最大可能工时 = 天数 * 24
- `utilization`：利用率 = (总工时 / 最大工时) * 100
- `avg_utilization`：平均利用率 = 所有资源利用率的平均值

## 5. 业务逻辑

### 5.1 资源创建规则

- 同一用户在同一项目中只能有一个资源记录
- 创建资源时检查用户和项目是否存在
- 如果资源已存在，返回错误："该用户已在此项目中分配资源"

### 5.2 资源分配规则

- 同一资源在同一天的总工时不能超过24小时
- 创建或更新资源分配时检查冲突
- 如果超过24小时，返回错误并阻止创建/更新

### 5.3 资源冲突检测

资源冲突检测规则：

1. **冲突（has_conflict）**：总工时超过24小时
2. **警告（has_warning）**：总工时超过12小时（建议检查）

**检测方式：**

- 基于用户ID检测：检查同一用户在同一天的所有资源分配
- 基于资源ID检测：检查同一资源在同一天的所有资源分配

### 5.4 资源统计

资源统计从ResourceAllocation表统计实际工时：

- **总工时**：所有资源分配的总工时
- **按项目统计**：按项目分组统计工时
- **按人员统计**：按人员分组统计工时
- **工时分类**：按任务、Bug、需求分类统计工时

### 5.5 资源利用率分析

资源利用率分析：

- **计算方式**：利用率 = (实际工时 / 最大可能工时) * 100
- **最大可能工时**：天数 * 24小时
- **时间范围**：支持自定义时间范围，默认当前月份
- **平均利用率**：所有资源利用率的平均值

### 5.6 资源分配自动创建

当更新任务或Bug的实际工时时，系统自动创建或更新资源分配记录：

- **任务工时更新**：更新任务的实际工时时，自动创建资源分配记录
- **Bug工时更新**：更新Bug的实际工时时，自动创建资源分配记录
- **资源分配记录**：包含资源ID、日期、工时、关联的任务/Bug/项目

### 5.7 资源日历

资源日历按日期分组显示资源分配：

- **日期分组**：按日期（YYYY-MM-DD）分组
- **日期范围**：支持自定义日期范围，默认当前月份
- **筛选**：支持按用户、项目筛选

## 6. 权限控制

### 6.1 资源权限

- **resource:read**：查看资源列表和详情
- **resource:create**：创建资源
- **resource:update**：更新资源
- **resource:delete**：删除资源

### 6.2 资源分配权限

- **resource-allocation:read**：查看资源分配列表和详情
- **resource-allocation:create**：创建资源分配
- **resource-allocation:update**：更新资源分配
- **resource-allocation:delete**：删除资源分配

### 6.3 数据权限

- 普通用户只能查看和操作自己参与的项目相关的资源和资源分配
- 管理员可以查看和操作所有资源和资源分配
- 项目成员可以查看和操作项目中的资源和资源分配

## 7. 前端实现

### 7.1 资源管理页面

- **资源列表**：支持筛选、搜索、分页
- **资源详情**：显示资源完整信息，包括资源分配列表
- **资源创建/编辑表单**：支持所有字段编辑
- **资源删除**：支持删除资源（检查关联的资源分配）

### 7.2 资源分配管理页面

- **资源分配列表**：支持筛选、搜索、分页
- **资源分配详情**：显示资源分配完整信息
- **资源分配创建/编辑表单**：支持所有字段编辑，支持日期选择器
- **资源分配删除**：支持删除资源分配

### 7.3 资源统计页面

- **总体统计**：显示总工时、按项目统计、按人员统计
- **工时分类**：显示任务工时、Bug工时、需求工时
- **统计图表**：使用图表可视化统计数据

### 7.4 资源冲突检测页面

- **冲突检测**：支持按用户或资源检测冲突
- **冲突列表**：显示冲突的详细分配情况
- **冲突预警**：显示警告和冲突标记

### 7.5 资源利用率分析页面

- **利用率统计**：显示各资源的利用率
- **平均利用率**：显示平均利用率
- **利用率图表**：使用图表可视化利用率数据

### 7.6 资源日历页面

- **日历视图**：按日期显示资源分配
- **日期范围选择**：支持选择日期范围
- **筛选功能**：支持按用户、项目筛选

## 8. 测试用例

### 8.1 资源管理测试

1. **创建资源测试**
   - 测试创建资源成功
   - 测试必填字段验证
   - 测试同一用户同一项目的唯一性约束
   - 测试用户和项目存在性验证

2. **更新资源测试**
   - 测试更新资源成功
   - 测试更新资源角色

3. **删除资源测试**
   - 测试删除资源成功
   - 测试删除有资源分配的资源

4. **资源筛选测试**
   - 测试按用户筛选
   - 测试按项目筛选
   - 测试按角色筛选

### 8.2 资源分配管理测试

1. **创建资源分配测试**
   - 测试创建资源分配成功
   - 测试必填字段验证
   - 测试工时冲突检测（超过24小时）
   - 测试关联任务、Bug、需求、项目

2. **更新资源分配测试**
   - 测试更新资源分配成功
   - 测试更新时冲突检测（排除当前记录）

3. **删除资源分配测试**
   - 测试删除资源分配成功

4. **资源分配筛选测试**
   - 测试按资源筛选
   - 测试按用户筛选
   - 测试按项目筛选
   - 测试按日期范围筛选

### 8.3 资源统计测试

1. **统计准确性测试**
   - 测试总工时统计准确性
   - 测试按项目统计准确性
   - 测试按人员统计准确性
   - 测试工时分类统计准确性

2. **统计筛选测试**
   - 测试按用户筛选统计
   - 测试按项目筛选统计

### 8.4 资源冲突检测测试

1. **冲突检测测试**
   - 测试检测冲突成功
   - 测试冲突规则（超过24小时）
   - 测试警告规则（超过12小时）
   - 测试冲突详情显示

### 8.5 资源利用率分析测试

1. **利用率计算测试**
   - 测试利用率计算准确性
   - 测试平均利用率计算准确性
   - 测试时间范围筛选

## 9. 注意事项

1. **资源唯一性**：同一用户在同一项目中只能有一个资源记录，通过应用层保证
2. **工时冲突检测**：同一资源在同一天的总工时不能超过24小时，创建和更新时都要检查
3. **资源分配自动创建**：更新任务或Bug的实际工时时，自动创建资源分配记录
4. **权限控制**：确保用户只能访问有权限的项目和资源
5. **数据完整性**：删除资源时检查关联的资源分配，删除资源分配时不影响任务和Bug
6. **性能优化**：资源分配列表查询时使用预加载（Preload）避免N+1问题
7. **日期格式**：日期使用"YYYY-MM-DD"格式，前端使用日期选择器
8. **工时精度**：工时使用float64类型，支持小数（如：0.5小时）

## 10. 未来优化

1. **资源容量管理**：支持设置资源的容量（每天最大工时），不同资源可以有不同的容量
2. **资源计划**：支持创建资源计划，提前规划资源分配
3. **资源负载均衡**：支持资源负载均衡分析，避免资源过载
4. **资源成本管理**：支持设置资源成本，计算项目成本
5. **资源技能管理**：支持管理资源技能，按技能分配资源
6. **资源可用性管理**：支持管理资源可用性（工作日、假期等）
7. **资源分配模板**：支持创建资源分配模板，快速创建相似分配
8. **资源分配审批**：支持资源分配审批流程
9. **资源报表导出**：支持导出资源报表（PDF、Excel）
10. **资源趋势分析**：支持资源趋势分析，显示资源使用趋势

