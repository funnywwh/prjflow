# 测试补充清单

## 一、缺少测试文件的API模块

### 1. 系统初始化模块（init.go）
- **文件**: `backend/internal/api/init.go`
- **Handler**: `InitHandler`
- **需要测试的方法**:
  - `CheckInitStatus` - 检查初始化状态
  - `SaveWeChatConfig` - 保存微信配置（第一步）
  - `InitSystem` - 初始化系统（第二步：微信扫码）
  - `GetInitQRCode` - 获取初始化二维码
  - `InitSystemWithPassword` - 密码初始化系统（第二步：用户名密码）

### 2. 初始化回调模块（init_callback.go, init_callback_handler.go）
- **文件**: 
  - `backend/internal/api/init_callback.go`
  - `backend/internal/api/init_callback_handler.go`
- **需要测试的方法**:
  - 初始化回调处理逻辑
  - 回调验证和错误处理

### 3. 系统管理模块（system.go）
- **文件**: `backend/internal/api/system.go`
- **Handler**: `SystemHandler`
- **需要测试的方法**:
  - `GetBackupConfig` - 获取备份配置
  - `SaveBackupConfig` - 保存备份配置
  - `TriggerBackup` - 触发备份
  - `GetLogLevel` - 获取日志级别
  - `SetLogLevel` - 设置日志级别
  - `GetLogFiles` - 获取日志文件列表
  - `DownloadLogFile` - 下载日志文件

### 4. 微信配置管理模块（wechat.go）
- **文件**: `backend/internal/api/wechat.go`
- **Handler**: `WeChatHandler`
- **需要测试的方法**:
  - `GetWeChatConfig` - 获取微信配置
  - `SaveWeChatConfig` - 保存微信配置

### 5. 微信回调模块（wechat_callback.go, wechat_verify.go）
- **文件**: 
  - `backend/internal/api/wechat_callback.go`
  - `backend/internal/api/wechat_verify.go`
- **需要测试的方法**:
  - 微信回调验证逻辑
  - 微信回调处理逻辑

### 6. 用户回调处理器（user_callback_handler.go）
- **文件**: `backend/internal/api/user_callback_handler.go`
- **需要测试的方法**:
  - 用户回调处理逻辑

## 二、测试失败的模块（需要修复）

### 1. Bug管理测试（bug_test.go）
- **失败的测试用例**:
  - `TestBugHandler_UpdateBug/更新Bug成功` - 期望标题为"已更新Bug"，实际为"更新Bug"；期望状态为"in_progress"，实际为"open"
  - `TestBugHandler_DeleteBug/删除Bug成功` - 期望有错误但未收到错误

### 2. 日报管理测试（daily_report_test.go）
- **失败的测试用例**:
  - `TestReportHandler_CreateDailyReport/创建日报成功` - 记录未找到，内容为空

### 3. 部门管理测试（department_test.go）
- **失败的测试用例**:
  - `TestDepartmentHandler_DeleteDepartment/删除部门成功` - 记录未找到

### 4. 权限管理测试（permission_test.go）
- **失败的测试用例**:
  - `TestPermissionHandler_GetRole/获取存在的角色` - 期望角色名为"test_role"，实际为"admin"
  - `TestPermissionHandler_UpdateRole/更新角色成功` - 期望角色名为"更新后的角色"，实际为"原始角色"
  - `TestPermissionHandler_DeleteRole/删除角色成功` - 期望有错误但未收到错误

## 三、测试覆盖率检查

### 需要检查覆盖率的模块
1. **认证模块**（auth.go）- 已有测试，需检查覆盖率
2. **用户管理**（user.go）- 已有测试，需检查覆盖率
3. **项目管理**（project.go）- 已有测试，需检查覆盖率
4. **需求管理**（requirement.go）- 已有测试，需检查覆盖率
5. **Bug管理**（bug.go）- 已有测试，需检查覆盖率
6. **任务管理**（task.go）- 已有测试，需检查覆盖率
7. **看板管理**（board.go）- 已有测试，需检查覆盖率
8. **版本管理**（version.go）- 已有测试，需检查覆盖率
9. **测试单管理**（test_case.go）- 已有测试，需检查覆盖率
10. **资源管理**（resource.go）- 已有测试，需检查覆盖率
11. **资源分配**（resource_allocation.go）- 已有测试，需检查覆盖率
12. **工作报告**（report.go）- 已有测试，需检查覆盖率
13. **个人工作台**（dashboard.go）- 已有测试，需检查覆盖率
14. **部门管理**（department.go）- 已有测试，需检查覆盖率
15. **权限管理**（permission.go）- 已有测试，需检查覆盖率
16. **标签管理**（tag.go）- 已有测试，需检查覆盖率
17. **模块管理**（module.go）- 已有测试，需检查覆盖率
18. **附件管理**（attachment.go）- 已有测试，需检查覆盖率
19. **微信绑定**（auth.go中的绑定相关方法）- 已有测试，需检查覆盖率

## 四、优先级建议

### 高优先级（核心功能，必须补充）
1. ✅ **修复失败的测试** - 确保现有测试通过
   - Bug管理测试修复
   - 日报管理测试修复
   - 部门管理测试修复
   - 权限管理测试修复
   - 需求管理测试修复
   - 资源管理测试修复
   - 任务管理测试修复
   - 测试单管理测试修复
   - 版本管理测试修复
   - 微信绑定测试修复
   - 周报管理测试修复

2. ✅ **系统初始化模块测试** - 系统核心功能
   - ✅ init.go 测试
   - ✅ init_callback.go 测试（基础测试已完成，完整测试需要mock微信API）

3. ✅ **系统管理模块测试** - 系统运维功能
   - ✅ system.go 测试

### 中优先级（重要功能）
4. ✅ **微信配置管理测试** - 认证相关
   - ✅ wechat.go 测试
   - ⏳ wechat_callback.go 测试（需要mock微信API，参见任务分解文档）
   - ✅ wechat_verify.go 测试

5. ✅ **回调处理器测试** - 回调逻辑
   - ✅ user_callback_handler.go 测试（基础测试已完成，Process方法需要mock微信API）
   - ✅ init_callback_handler.go 测试（基础测试已完成，Process方法需要mock微信API）
   - 📋 **完整测试任务分解**: 参见 `docs/Mock微信API测试任务分解.md`

### 低优先级（辅助功能）
6. ⏳ **测试覆盖率提升** - 确保所有模块达到100%覆盖率
   - 运行覆盖率检查
   - 补充缺失的测试用例

## 五、测试编写规范

### 测试文件命名
- 测试文件命名：`{模块名}_test.go`
- 例如：`init_test.go`, `system_test.go`, `wechat_test.go`

### 测试结构
```go
func Test{Handler}_{Method}(t *testing.T) {
    db := SetupTestDB(t)
    defer TeardownTestDB(t, db)
    
    handler := api.New{Handler}(db)
    
    t.Run("测试场景1", func(t *testing.T) {
        // 测试代码
    })
    
    t.Run("测试场景2", func(t *testing.T) {
        // 测试代码
    })
}
```

### 测试覆盖要求
- 每个Handler方法至少包含以下测试场景：
  1. 成功场景
  2. 参数错误场景
  3. 权限不足场景（如适用）
  4. 资源不存在场景（如适用）
  5. 边界条件场景

### 测试数据准备
- 使用 `SetupTestDB` 创建测试数据库
- 使用 `test_helper.go` 中的辅助函数创建测试数据
- 测试结束后使用 `TeardownTestDB` 清理

## 六、Mock基础设施和微信回调测试补充（已完成）

### 1. Mock基础设施
- ✅ **WeChatClient接口** (`pkg/wechat/client_interface.go`)
  - 定义了 `WeChatClientInterface` 接口，支持依赖注入
  - 添加了 getter/setter 方法用于配置管理
  
- ✅ **MockWeChatClient** (`tests/unit/mocks/wechat_client_mock.go`)
  - 完整的 Mock 实现，支持配置返回值和错误
  - 记录调用次数和参数，便于测试验证
  
- ✅ **WebSocket Hub接口** (`internal/websocket/hub_interface.go`)
  - 定义了 `HubInterface` 接口，支持依赖注入
  
- ✅ **MockWebSocketHub** (`tests/unit/mocks/websocket_hub_mock.go`)
  - 完整的 Mock 实现，记录所有发送的消息
  - 支持按 ticket、类型查询消息

### 2. 代码重构
- ✅ **WeChatCallbackContext** - 使用接口类型替代具体类型
- ✅ **ProcessWeChatCallback** - 接受接口类型参数，支持 Mock 注入
- ✅ **所有WebSocket调用** - 通过 `ctx.Hub` 使用接口，支持 Mock
- ✅ **InitCallbackHandler** - 添加 `SetWeChatClient` 方法支持依赖注入

### 3. 测试补充
- ✅ **ProcessWeChatCallback测试** (`wechat_callback_test.go`)
  - 成功场景：有ticket、无ticket
  - 错误场景：code为空、配置未设置、GetAccessToken失败、GetUserInfo失败、Validate失败
  
- ✅ **InitCallbackHandlerImpl.Process测试** (`init_callback_handler_test.go`)
  - 成功场景：创建管理员并初始化系统、管理员角色已存在
  - 错误场景：系统已初始化、创建用户失败（OpenID冲突）
  
- ✅ **AddUserCallbackHandler.Process测试** (`user_callback_handler_test.go`)
  - 成功场景：创建新用户、恢复软删除用户、恢复用户但昵称为空
  - 错误场景：用户已存在且未删除
  
- ✅ **InitCallbackHandler.HandleCallback测试** (`init_callback_test.go`)
  - 完整流程测试：使用 Mock 测试成功场景
  - 错误场景：缺少参数、配置未设置、系统已初始化

### 4. 测试覆盖率
- 当前总体覆盖率：**50.7%**
- 微信回调相关模块覆盖率已显著提升
- 使用 Mock 后，可以测试完整的回调流程，包括微信 API 调用和 WebSocket 消息发送

## 七、下一步行动

1. ✅ **Mock基础设施** - 已完成
2. ✅ **微信回调测试补充** - 已完成
3. **补充系统初始化模块测试** - 编写 init_test.go（部分完成，HandleCallback已测试）
4. **补充系统管理模块测试** - 编写 system_test.go
5. **补充微信配置管理测试** - 编写 wechat_test.go
6. **运行覆盖率检查** - 使用 `go test -cover` 检查各模块覆盖率
7. **补充缺失的测试用例** - 根据覆盖率报告补充测试

---
**文档版本**: v1.1  
**创建日期**: 2025年12月4日  
**最后更新**: 2025年12月4日  
**维护者**: 开发团队

