# 版本与构建管理详细设计文档

## 1. 概述

版本与构建管理系统用于管理项目的版本发布，跟踪版本状态，关联版本相关的需求和Bug，记录版本发布说明。系统支持版本创建、更新、状态管理、关联需求和Bug，以及Markdown格式的发布说明。

**注意：** 当前实现中，系统直接使用版本管理，没有独立的构建管理模块。版本可以独立创建和管理，不依赖于构建流程。

## 2. 功能特性

### 2.1 版本管理

- **版本CRUD**：创建、查看、更新、删除版本
- **版本状态管理**：支持版本状态流转（未开始、已发布、发布失败、停止维护）
- **版本关联**：支持版本关联需求和Bug（多对多关系）
- **发布说明**：支持Markdown格式的发布说明
- **发布日期**：支持设置版本发布日期
- **版本筛选**：支持按项目、状态、关键词筛选版本

### 2.2 版本发布流程

- **版本创建**：创建新版本，设置版本号、发布说明、关联需求和Bug
- **版本发布**：将版本状态更新为"已发布"，设置发布日期
- **版本维护**：版本发布后可以停止维护

## 3. 数据模型

### 3.1 版本表（versions）

```go
type Version struct {
    ID        uint           `gorm:"primarykey" json:"id"`
    CreatedAt time.Time      `json:"created_at"`
    UpdatedAt time.Time      `json:"updated_at"`
    DeletedAt gorm.DeletedAt `gorm:"index" json:"-"`

    VersionNumber string `gorm:"size:50;not null" json:"version_number"` // 版本号
    ReleaseNotes  string `gorm:"type:text" json:"release_notes"`         // 发布说明（Markdown）
    Status        string `gorm:"size:20;default:'wait'" json:"status"`   // 状态：wait(未开始), normal(已发布), fail(发布失败), terminate(停止维护)

    ProjectID uint    `gorm:"index;not null" json:"project_id"` // 关联项目
    Project   Project `gorm:"foreignKey:ProjectID" json:"project,omitempty"`

    ReleaseDate *time.Time `json:"release_date"` // 发布日期

    // 关联需求和Bug
    Requirements []Requirement `gorm:"many2many:version_requirements;" json:"requirements,omitempty"`
    Bugs         []Bug         `gorm:"many2many:version_bugs;" json:"bugs,omitempty"`
}
```

**字段说明：**

- `VersionNumber`：版本号，必填，最大长度50字符，建议使用语义化版本号（如：v1.0.0、v2.1.3）
- `ReleaseNotes`：发布说明，支持Markdown格式，用于记录版本变更内容
- `Status`：版本状态，默认值为"wait"（未开始）
  - `wait`：未开始（版本已创建但未发布）
  - `normal`：已发布（版本已发布）
  - `fail`：发布失败（版本发布失败）
  - `terminate`：停止维护（版本已停止维护）
- `ProjectID`：关联的项目ID，必填
- `ReleaseDate`：发布日期，可选，版本发布时设置
- `Requirements`：关联的需求列表（多对多）
- `Bugs`：关联的Bug列表（多对多）

### 3.2 版本-需求关联表（version_requirements）

版本和需求的多对多关联表，用于记录版本包含的需求。

**表结构：**

- `version_id`：版本ID（主键）
- `requirement_id`：需求ID（主键）

### 3.3 版本-Bug关联表（version_bugs）

版本和Bug的多对多关联表，用于记录版本修复的Bug。

**表结构：**

- `version_id`：版本ID（主键）
- `bug_id`：BugID（主键）

## 4. API设计

### 4.1 版本管理API

#### 4.1.1 获取版本列表

**接口：** `GET /api/versions`

**权限：** `version:read`

**查询参数：**

- `keyword`：搜索关键词（版本号、发布说明）
- `project_id`：项目ID
- `status`：版本状态
- `page`：页码，默认1
- `size`：每页数量，默认10

**响应示例：**

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "version_number": "v1.0.0",
        "release_notes": "# v1.0.0 发布说明\n\n## 新功能\n- 功能1\n- 功能2",
        "status": "normal",
        "project_id": 1,
        "project": {
          "id": 1,
          "name": "项目名称"
        },
        "release_date": "2024-01-01T00:00:00Z",
        "requirements": [
          {
            "id": 1,
            "title": "需求1"
          }
        ],
        "bugs": [
          {
            "id": 1,
            "title": "Bug1"
          }
        ],
        "created_at": "2024-01-01T00:00:00Z",
        "updated_at": "2024-01-01T00:00:00Z"
      }
    ],
    "total": 50,
    "page": 1,
    "page_size": 10
  }
}
```

#### 4.1.2 获取版本详情

**接口：** `GET /api/versions/:id`

**权限：** `version:read`

**响应示例：**

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "version_number": "v1.0.0",
    "release_notes": "# v1.0.0 发布说明\n\n## 新功能\n- 功能1\n- 功能2",
    "status": "normal",
    "project_id": 1,
    "project": {
      "id": 1,
      "name": "项目名称",
      "code": "PROJECT001"
    },
    "release_date": "2024-01-01T00:00:00Z",
    "requirements": [
      {
        "id": 1,
        "title": "需求1",
        "status": "closed"
      },
      {
        "id": 2,
        "title": "需求2",
        "status": "closed"
      }
    ],
    "bugs": [
      {
        "id": 1,
        "title": "Bug1",
        "status": "closed"
      },
      {
        "id": 2,
        "title": "Bug2",
        "status": "closed"
      }
    ],
    "created_at": "2024-01-01T00:00:00Z",
    "updated_at": "2024-01-01T00:00:00Z"
  }
}
```

#### 4.1.3 创建版本

**接口：** `POST /api/versions`

**权限：** `version:create`

**请求体：**

```json
{
  "version_number": "v1.0.0",
  "release_notes": "# v1.0.0 发布说明\n\n## 新功能\n- 功能1\n- 功能2",
  "status": "wait",
  "project_id": 1,
  "release_date": "2024-01-01",
  "requirement_ids": [1, 2, 3],
  "bug_ids": [1, 2]
}
```

**字段说明：**

- `version_number`：版本号，必填
- `release_notes`：发布说明，可选，支持Markdown格式
- `status`：版本状态，可选，默认值为"wait"
- `project_id`：项目ID，必填
- `release_date`：发布日期，可选，格式为"YYYY-MM-DD"
- `requirement_ids`：关联的需求ID列表，可选
- `bug_ids`：关联的BugID列表，可选

**响应示例：**

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "version_number": "v1.0.0",
    "release_notes": "# v1.0.0 发布说明\n\n## 新功能\n- 功能1\n- 功能2",
    "status": "wait",
    "project_id": 1,
    "project": {
      "id": 1,
      "name": "项目名称"
    },
    "release_date": null,
    "requirements": [
      {
        "id": 1,
        "title": "需求1"
      },
      {
        "id": 2,
        "title": "需求2"
      },
      {
        "id": 3,
        "title": "需求3"
      }
    ],
    "bugs": [
      {
        "id": 1,
        "title": "Bug1"
      },
      {
        "id": 2,
        "title": "Bug2"
      }
    ],
    "created_at": "2024-01-01T00:00:00Z",
    "updated_at": "2024-01-01T00:00:00Z"
  }
}
```

#### 4.1.4 更新版本

**接口：** `PUT /api/versions/:id`

**权限：** `version:update`

**请求体：**

```json
{
  "version_number": "v1.0.1",
  "release_notes": "# v1.0.1 发布说明\n\n## 修复\n- 修复Bug1\n- 修复Bug2",
  "status": "normal",
  "release_date": "2024-01-15",
  "requirement_ids": [1, 2, 3, 4],
  "bug_ids": [1, 2, 3]
}
```

**说明：**

- 更新版本时，可以更新版本号、发布说明、状态、发布日期
- 更新关联的需求和Bug时，使用新的ID列表替换原有关联

#### 4.1.5 删除版本

**接口：** `DELETE /api/versions/:id`

**权限：** `version:delete`

**响应示例：**

```json
{
  "code": 200,
  "message": "删除成功"
}
```

#### 4.1.6 更新版本状态

**接口：** `PUT /api/versions/:id/status`

**权限：** `version:update`

**请求体：**

```json
{
  "status": "normal"
}
```

**状态流转规则：**

- `wait` → `normal`：版本发布
- `wait` → `fail`：版本发布失败
- `normal` → `terminate`：版本停止维护
- `fail` → `normal`：重新发布版本

**说明：**

- 当状态更新为"normal"（已发布）时，如果未设置发布日期，系统自动设置发布日期为当前日期
- 当状态更新为"normal"时，系统可以自动更新关联的需求和Bug状态（可选功能）

#### 4.1.7 发布版本

**接口：** `POST /api/versions/:id/release`

**权限：** `version:update`

**请求体：**

```json
{
  "release_date": "2024-01-15"
}
```

**说明：**

- 发布版本时，系统自动将状态更新为"normal"（已发布）
- 如果未提供发布日期，系统自动设置发布日期为当前日期
- 发布版本后，可以记录发布日志（可选功能）

## 5. 业务逻辑

### 5.1 版本号规范

建议使用语义化版本号（Semantic Versioning）：

- **主版本号（Major）**：不兼容的API修改
- **次版本号（Minor）**：向下兼容的功能性新增
- **修订号（Patch）**：向下兼容的问题修正

**示例：**

- `v1.0.0`：第一个正式版本
- `v1.1.0`：新增功能
- `v1.1.1`：修复Bug
- `v2.0.0`：重大更新，不兼容旧版本

**注意：** 系统不强制版本号格式，但建议遵循语义化版本规范。

### 5.2 版本状态流转

版本状态流转规则：

1. **未开始（wait）** → **已发布（normal）**：版本发布
2. **未开始（wait）** → **发布失败（fail）**：版本发布失败
3. **已发布（normal）** → **停止维护（terminate）**：版本停止维护
4. **发布失败（fail）** → **已发布（normal）**：重新发布版本

**状态流转限制：**

- 已停止维护的版本不能再次发布
- 已发布的版本可以停止维护

### 5.3 版本关联需求和Bug

版本可以关联多个需求和Bug：

- **关联需求**：记录版本包含的功能需求
- **关联Bug**：记录版本修复的Bug

**关联规则：**

- 一个版本可以关联多个需求和Bug
- 一个需求或Bug可以关联多个版本
- 删除版本时，不删除关联的需求和Bug，只删除关联关系

### 5.4 版本发布流程

版本发布流程：

1. **创建版本**：创建新版本，设置版本号、发布说明
2. **关联需求和Bug**：将相关需求和Bug关联到版本
3. **发布版本**：将版本状态更新为"已发布"，设置发布日期
4. **版本维护**：版本发布后可以停止维护

**发布检查（可选）：**

- 检查关联的需求是否已完成
- 检查关联的Bug是否已修复
- 检查版本号是否重复

### 5.5 发布说明格式

发布说明支持Markdown格式，建议包含以下内容：

```markdown
# v1.0.0 发布说明

## 新功能
- 功能1
- 功能2

## 修复
- 修复Bug1
- 修复Bug2

## 改进
- 改进1
- 改进2

## 已知问题
- 问题1
- 问题2
```

## 6. 权限控制

### 6.1 版本权限

- **version:read**：查看版本列表和详情
- **version:create**：创建版本
- **version:update**：更新版本（包括状态、发布等）
- **version:delete**：删除版本

### 6.2 数据权限

- 普通用户只能查看和操作自己参与的项目中的版本
- 管理员可以查看和操作所有版本
- 项目成员可以查看和操作项目中的版本

## 7. 前端实现

### 7.1 版本管理页面

- **版本列表**：支持筛选、搜索、分页
- **版本详情**：显示版本完整信息，包括关联的需求和Bug
- **版本创建/编辑表单**：支持所有字段编辑，支持Markdown编辑器
- **版本状态切换**：支持快速切换版本状态
- **版本发布**：支持一键发布版本

### 7.2 版本关联管理

- **关联需求**：支持从需求列表选择关联到版本
- **关联Bug**：支持从Bug列表选择关联到版本
- **关联展示**：在版本详情中展示关联的需求和Bug列表

### 7.3 发布说明编辑

- **Markdown编辑器**：使用Markdown编辑器编辑发布说明
- **发布说明预览**：支持实时预览Markdown渲染效果
- **发布说明模板**：提供发布说明模板，快速生成发布说明

## 8. 测试用例

### 8.1 版本管理测试

1. **创建版本测试**
   - 测试创建版本成功
   - 测试必填字段验证
   - 测试版本号唯一性（可选）
   - 测试关联需求和Bug

2. **更新版本测试**
   - 测试更新版本成功
   - 测试状态流转
   - 测试更新关联关系和Bug

3. **删除版本测试**
   - 测试删除版本成功
   - 测试删除后关联关系清除

4. **版本筛选测试**
   - 测试按项目筛选
   - 测试按状态筛选
   - 测试搜索功能

### 8.2 版本发布测试

1. **发布版本测试**
   - 测试发布版本成功
   - 测试自动设置发布日期
   - 测试状态自动更新

2. **版本状态流转测试**
   - 测试状态流转规则
   - 测试状态流转限制

### 8.3 版本关联测试

1. **关联需求测试**
   - 测试关联需求成功
   - 测试更新关联关系
   - 测试删除关联关系

2. **关联Bug测试**
   - 测试关联Bug成功
   - 测试更新关联关系
   - 测试删除关联关系

## 9. 注意事项

1. **版本号唯一性**：建议在同一项目内保持版本号唯一，系统不强制但建议遵循
2. **版本状态一致性**：确保版本状态与发布流程一致
3. **关联关系**：删除版本时确保关联关系正确清除
4. **权限控制**：确保用户只能访问有权限的项目和版本
5. **数据完整性**：删除版本时检查关联关系，确保数据完整性
6. **性能优化**：版本列表查询时使用预加载（Preload）避免N+1问题
7. **Markdown渲染**：前端正确渲染发布说明的Markdown内容
8. **发布日期**：发布版本时自动设置发布日期，避免手动设置错误

## 10. 未来优化

1. **构建管理**：添加独立的构建管理模块，一个构建产生一个版本
2. **版本比较**：支持版本之间的比较，显示版本差异
3. **版本回滚**：支持版本回滚功能
4. **版本标签**：支持为版本添加标签，方便分类和筛选
5. **版本统计**：支持版本发布统计，显示版本发布趋势
6. **发布检查**：添加发布前检查，确保关联的需求和Bug已完成
7. **版本模板**：支持创建版本模板，快速创建相似版本
8. **发布通知**：支持版本发布通知功能
9. **版本归档**：支持版本归档功能，归档旧版本
10. **版本依赖**：支持版本之间的依赖关系

## 11. 构建管理（未来扩展）

虽然当前实现中没有独立的构建管理模块，但可以根据需要扩展：

### 11.1 构建表（builds）

```go
type Build struct {
    ID        uint           `gorm:"primarykey" json:"id"`
    CreatedAt time.Time      `json:"created_at"`
    UpdatedAt time.Time      `json:"updated_at"`
    DeletedAt gorm.DeletedAt `gorm:"index" json:"-"`

    BuildNumber string `gorm:"size:50;not null" json:"build_number"` // 构建号
    Status      string `gorm:"size:20;default:'pending'" json:"status"` // 状态：pending(待构建), building(构建中), success(成功), fail(失败)
    BuildTime   *time.Time `json:"build_time"` // 构建时间

    ProjectID uint    `gorm:"index;not null" json:"project_id"`
    Project   Project `gorm:"foreignKey:ProjectID" json:"project,omitempty"`

    VersionID *uint   `gorm:"index" json:"version_id"` // 关联的版本ID
    Version   *Version `gorm:"foreignKey:VersionID" json:"version,omitempty"`
}
```

### 11.2 构建流程

1. **创建构建**：创建新的构建记录
2. **执行构建**：执行构建流程，更新构建状态
3. **创建版本**：构建成功后，自动创建版本
4. **关联版本**：将构建与版本关联

### 11.3 构建API

- `GET /api/builds`：获取构建列表
- `GET /api/builds/:id`：获取构建详情
- `POST /api/builds`：创建构建
- `PUT /api/builds/:id`：更新构建
- `DELETE /api/builds/:id`：删除构建
- `POST /api/builds/:id/trigger`：触发构建

