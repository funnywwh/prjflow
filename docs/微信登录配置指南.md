# 微信登录配置指南

## ⚠️ 重要：两种微信登录方式

系统支持两种微信登录方式，请根据您的 AppID 来源选择：

### 方式1：微信开放平台网站应用（推荐，支持扫码登录）

- **AppID 来源**：[微信开放平台](https://open.weixin.qq.com/) > 管理中心 > 网站应用
- **特点**：支持扫码登录，用户可以在电脑上扫码完成登录
- **授权URL**：`https://open.weixin.qq.com/connect/qrconnect`
- **配置项**：需要在开放平台配置"授权回调域名"
- **适用场景**：网站登录、PC端应用

### 方式2：微信公众平台公众号（网页授权）

- **AppID 来源**：[微信公众平台](https://mp.weixin.qq.com/) > 开发 > 基本配置
- **特点**：网页授权，可以生成二维码，扫码后会在微信内打开授权页面
- **授权URL**：`https://open.weixin.qq.com/connect/oauth2/authorize`
- **配置项**：需要在公众号后台配置"网页授权域名"
- **适用场景**：H5页面、微信内打开的应用
- **说明**：可以生成二维码，用户扫码后会在微信内打开授权页面，确认后完成登录

**如果您使用的是公众号 AppID，请跳转到 [第2节：公众号配置](#2-公众号配置)**

---

## 1. 微信开放平台应用配置（扫码登录）

### 问题：scope参数错误或没有scope权限

如果遇到"scope参数错误或没有scope权限"的错误，请按照以下步骤检查配置：

### 1.1 创建网站应用

1. 登录 [微信开放平台](https://open.weixin.qq.com/)
2. 进入"管理中心" > "网站应用"
3. 点击"创建网站应用"
4. 填写应用信息：
   - 应用名称：项目管理系统
   - 应用简介：项目管理系统
   - 应用官网：您的网站地址
   - 应用图标：上传应用图标

### 1.2 配置授权回调域名

**重要**：这是解决"scope参数错误"的关键步骤！

#### 授权回调域名的作用

授权回调域名是微信开放平台用来**验证 redirect_uri 是否可信**的安全机制：

1. **验证机制**：
   - 当用户扫码后，微信会跳转到您指定的 `redirect_uri`（如 `https://abc123.ngrok.io/init/callback`）
   - 微信会检查 `redirect_uri` 的**域名部分**是否在"授权回调域名"列表中
   - 如果域名匹配，允许跳转；如果不匹配，返回"scope参数错误"

2. **配置规则**：
   - 只填写**域名**，不包含协议（http/https）、端口号、路径
   - 例如：如果回调地址是 `https://abc123.ngrok.io:443/init/callback`
   - 授权回调域名应该只填写：`abc123.ngrok.io`

3. **为什么手机访问不了 localhost**：
   - `localhost` 是本地回环地址（127.0.0.1），只能在本机访问
   - 手机和开发机是不同设备，手机无法访问开发机的 `localhost`
   - 即使配置了 `localhost` 作为授权回调域名，手机扫码后也无法跳转回开发机

#### 配置步骤

1. 在网站应用详情页面，找到"授权回调域名"配置
2. 添加您的域名（**只填写域名，不包含协议、端口、路径**）：
   - 开发环境：需要使用内网穿透工具获取公网域名（见下方说明）
   - 生产环境：`yourdomain.com`（不包含 http:// 或 https://）
3. 保存配置

**重要提示**：
- 域名必须与实际使用的域名完全一致
- **不要包含端口号**（如 `localhost:3000` 应该只填写域名部分）
- **不要包含路径**（如 `localhost/init/callback` 应该只填写 `localhost`）
- **微信开放平台不支持 localhost**，本地开发需要使用：
  - 内网穿透工具（如 ngrok、natapp）获取公网域名
  - 或者使用真实域名进行测试
- 如果使用IP地址，填写IP地址即可（但微信可能不支持IP地址）

#### 本地开发推荐方案

**方案1：使用内网穿透（推荐，支持手机测试）**

```bash
# 安装 ngrok
# 启动内网穿透
ngrok http 3000
# 获取公网地址，例如：https://abc123.ngrok.io
# 在微信开放平台配置授权回调域名为：abc123.ngrok.io
```

**方案2：使用局域网IP（仅限同一WiFi网络）**

1. 确保手机和开发机连接同一WiFi
2. 获取开发机的局域网IP（如 `192.168.1.100`）
3. 在微信开放平台配置授权回调域名为：`192.168.1.100`
4. 系统回调地址会自动使用：`http://192.168.1.100:3000/init/callback`
5. 手机访问：`http://192.168.1.100:3000`（注意：微信可能不支持IP地址）

**方案3：使用真实域名（生产环境）**

使用您自己的域名进行开发和测试

### 1.3 申请接口权限

1. 在网站应用详情页面，找到"接口权限"
2. 确保已申请并获得了"微信登录"接口权限
3. 如果未申请，点击"申请"按钮进行申请

### 1.4 获取 AppID 和 AppSecret

1. 在网站应用详情页面，找到"开发信息"
2. 复制 **AppID** 和 **AppSecret**
3. 在系统初始化时填入这些信息

## 2. 系统配置

### 2.1 初始化配置

在系统初始化页面：
1. 输入微信 AppID
2. 输入微信 AppSecret
3. 保存配置

### 2.2 回调地址配置

#### 回调地址的作用

回调地址是用户扫码授权后，微信跳转回来的地址。**这个地址必须是手机能访问的**！

**工作流程**：
1. 用户在手机上用微信扫码
2. 微信显示授权页面
3. 用户点击"同意"后，微信跳转到回调地址（如 `https://abc123.ngrok.io/init/callback?code=xxx&state=xxx`）
4. 前端回调页面接收 `code` 参数
5. 前端调用后端API，用 `code` 换取用户信息
6. 完成登录/初始化

#### 回调地址格式

系统会根据当前访问的域名自动生成回调地址：
- 如果使用内网穿透：`https://abc123.ngrok.io/init/callback`（初始化）
- 如果使用内网穿透：`https://abc123.ngrok.io/auth/wechat/callback`（登录）
- 生产环境：`https://yourdomain.com/init/callback`（初始化）
- 生产环境：`https://yourdomain.com/auth/wechat/callback`（登录）

**重要**：
- 回调地址的**域名部分**必须在微信开放平台的"授权回调域名"中配置
- 回调地址必须是**手机能访问的地址**（不能是 localhost）
- 生产环境必须使用 HTTPS

## 3. 常见问题排查

### 问题1：scope参数错误

**原因**：
- 授权回调域名未配置或配置错误
- 应用未获得"微信登录"接口权限

**解决方案**：
1. 检查微信开放平台中"授权回调域名"是否正确配置
2. 确保应用已获得"微信登录"接口权限
3. 检查回调地址的域名是否与配置的域名一致

### 问题2：redirect_uri参数错误

**原因**：
- redirect_uri 未进行URL编码
- redirect_uri 的域名不在授权回调域名列表中

**解决方案**：
- 代码已自动处理URL编码
- 确保回调地址的域名在微信开放平台中配置

### 问题3：应用类型错误

**注意**：
- 必须使用**网站应用**，不能使用公众号
- 订阅号不具备网页授权权限
- 未认证的服务号也无法使用高级接口

## 4. 开发环境配置

### 为什么不能使用 localhost？

**问题**：`http://localhost:3000/init/callback` 只能在开发机上访问，手机无法访问。

**原因**：
- `localhost` 指向本机（127.0.0.1）
- 手机和开发机是不同设备
- 手机扫码后，微信尝试跳转到 `localhost`，但手机无法访问开发机的 localhost

**解决方案**：必须使用手机能访问的地址

### 方案1：使用内网穿透（推荐）

**步骤**：

1. **启动内网穿透**：
   ```bash
   # 安装 ngrok
   # 启动内网穿透（映射到前端端口）
   ngrok http 3000
   # 会显示类似：
   # Forwarding  https://abc123.ngrok.io -> http://localhost:3000
   ```

2. **配置微信开放平台**：
   - 授权回调域名填写：`abc123.ngrok.io`（不包含协议和端口）

3. **访问系统**：
   - 在浏览器访问：`https://abc123.ngrok.io`
   - 系统会自动使用正确的回调地址：`https://abc123.ngrok.io/init/callback`

4. **测试流程**：
   - 在电脑浏览器打开：`https://abc123.ngrok.io/init`
   - 配置微信 AppID 和 AppSecret
   - 获取二维码
   - 用手机微信扫码
   - 手机授权后，会跳转到：`https://abc123.ngrok.io/init/callback?code=xxx`
   - 手机能正常访问这个地址，完成初始化

### 方案2：使用局域网IP（仅限同一WiFi）

**限制**：手机和开发机必须在同一WiFi网络

**步骤**：

1. **获取开发机IP**：
   ```bash
   # Linux/Mac
   ifconfig | grep "inet "
   # 或
   ip addr show
   # 找到局域网IP，如：192.168.1.100
   ```

2. **配置微信开放平台**：
   - 授权回调域名填写：`192.168.1.100`（注意：微信可能不支持IP地址）

3. **访问系统**：
   - 在手机浏览器访问：`http://192.168.1.100:3000`
   - 系统会自动使用：`http://192.168.1.100:3000/init/callback`

**注意**：微信开放平台可能不支持IP地址作为授权回调域名，建议使用方案1。

## 2. 公众号配置（网页授权）

### 2.1 获取公众号 AppID 和 AppSecret

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入"开发" > "基本配置"
3. 复制 **AppID(应用ID)** 和 **AppSecret(应用密钥)**
4. 在系统初始化时填入这些信息

### 2.2 配置网页授权域名

**重要**：公众号网页授权需要在微信公众平台配置"网页授权域名"！

1. 在公众号后台，进入"开发" > "接口权限" > "网页授权"
2. 点击"修改"，添加您的域名（**只填写域名，不包含协议、端口、路径**）
3. 例如：如果回调地址是 `https://abc123.ngrok.io/init/callback`
4. 网页授权域名应该只填写：`abc123.ngrok.io`

**重要提示**：
- 域名必须与实际使用的域名完全一致
- **不要包含端口号**（如 `localhost:3000` 应该只填写域名部分）
- **不要包含路径**（如 `localhost/init/callback` 应该只填写 `localhost`）
- **公众号不支持 localhost**，本地开发需要使用内网穿透工具

### 2.3 配置系统

在系统初始化时：
1. 输入公众号 AppID
2. 输入公众号 AppSecret
3. 系统会自动识别为公众号模式（`account_type: "official_account"`）

### 2.4 公众号网页授权说明

**工作流程**：
1. 系统生成授权URL并转换为二维码
2. 用户使用微信扫码
3. 扫码后会在微信内打开授权页面
4. 用户确认授权后，跳转到回调地址
5. 完成登录/初始化

**与开放平台的区别**：
- 开放平台：扫码后在微信中确认授权，然后跳转到回调地址
- 公众号：扫码后在微信内打开授权页面，确认后跳转到回调地址
- 两种方式都可以生成二维码，用户体验类似

### 2.5 本地开发配置

**使用内网穿透（推荐）**：

```bash
# 启动内网穿透
ngrok http 3000
# 获取公网地址，例如：https://abc123.ngrok.io
# 在公众号后台配置网页授权域名为：abc123.ngrok.io
```

**测试流程**：
1. 在电脑浏览器打开：`https://abc123.ngrok.io/init`
2. 配置公众号 AppID 和 AppSecret
3. 系统会自动生成二维码（授权URL转换为二维码）
4. 使用微信扫码
5. 扫码后会在微信内打开授权页面
6. 用户确认授权后，会跳转到：`https://abc123.ngrok.io/init/callback?code=xxx`
7. 完成初始化

## 3. 系统配置

### 3.1 配置文件设置

在 `backend/config.yaml` 中配置：

```yaml
wechat:
  app_id: "您的AppID"
  app_secret: "您的AppSecret"
  # 如果使用公众号，设置为 "official_account"
  # 如果使用开放平台，设置为 "open_platform"（默认）
  account_type: "official_account"  # 或 "open_platform"
  # 仅公众号使用，开放平台固定使用 snsapi_login
  scope: "snsapi_userinfo"  # 或 "snsapi_base"
```

### 3.2 初始化配置

在系统初始化页面：
1. 输入微信 AppID
2. 输入微信 AppSecret
3. 系统会根据配置自动选择授权方式

## 4. 生产环境配置

### 4.1 开放平台网站应用

1. 在微信开放平台配置授权回调域名为您的生产域名
2. 确保回调地址使用 HTTPS（微信要求）
3. 在系统初始化时，系统会自动使用正确的回调地址

### 4.2 公众号

1. 在公众号后台配置网页授权域名为您的生产域名
2. 确保回调地址使用 HTTPS（微信要求）
3. 在系统初始化时，系统会自动使用正确的回调地址

## 5. 验证配置

配置完成后，可以通过以下方式验证：

1. 访问系统初始化页面
2. 配置微信 AppID 和 AppSecret
3. 获取二维码
4. 使用微信扫码
5. 如果配置正确，应该能够正常跳转到授权页面

## 6. 注意事项

1. **域名配置**：授权回调域名（开放平台）或网页授权域名（公众号）必须与实际使用的域名完全一致
2. **HTTPS要求**：生产环境必须使用 HTTPS
3. **接口权限**：
   - 开放平台：确保应用已获得"微信登录"接口权限
   - 公众号：确保已开通网页授权功能
4. **应用类型**：
   - 开放平台：必须使用网站应用
   - 公众号：支持服务号和已认证的订阅号
5. **URL编码**：redirect_uri 会自动进行URL编码，无需手动处理
6. **二维码生成**：两种方式都支持生成二维码
   - 开放平台：扫码后在微信中确认授权
   - 公众号：扫码后在微信内打开授权页面

## 7. 技术支持

如果按照以上步骤配置后仍有问题，请检查：
1. 微信开放平台应用状态是否正常
2. 接口权限是否已获得
3. 授权回调域名是否正确配置
4. 回调地址的域名是否与配置的域名一致

