# 权限管理设计文档

## 1. 概述

系统采用基于角色的访问控制（RBAC - Role-Based Access Control）模型，实现细粒度的权限管理。权限系统支持菜单权限和操作权限的分离，可以灵活控制用户对系统资源的访问。

## 2. 权限模型

### 2.1 RBAC 模型

系统采用标准的 RBAC 模型，包含以下核心概念：

- **用户（User）**：系统的使用者
- **角色（Role）**：权限的集合，如"管理员"、"测试员"等
- **权限（Permission）**：对特定资源的操作权限，如"查看用户"、"创建项目"等
- **资源（Resource）**：系统管理的对象，如"用户"、"项目"、"需求"等
- **操作（Action）**：对资源的操作类型，如"read"、"create"、"update"、"delete"、"menu"等

### 2.2 权限类型

权限分为两种类型：

1. **菜单权限**：控制菜单的显示，通常以 `:menu` 结尾（如 `user:menu`、`requirement:menu`）
   - 用于控制前端菜单的显示/隐藏
   - 用户拥有菜单权限才能看到对应的菜单项

2. **操作权限**：控制 API 的访问，通常以 `:read`、`:create`、`:update`、`:delete` 等结尾
   - 用于控制后端 API 的访问权限
   - 用户拥有操作权限才能执行对应的操作

**注意**：菜单权限和操作权限是独立的，需要分别分配。例如：
- 用户需要 `user:menu` 权限才能看到"用户管理"菜单
- 用户需要 `user:read` 权限才能访问用户列表 API
- 如果用户只有操作权限而没有菜单权限，可以访问 API 但看不到菜单
- 如果用户只有菜单权限而没有操作权限，可以看到菜单但无法访问 API（会返回 403 错误）

## 3. 数据模型

### 3.1 用户表（users）

```go
type User struct {
    ID           uint
    Username     string  // 用户名（用于登录）
    Nickname     string  // 昵称（用于显示）
    Password     string  // 密码（加密存储）
    WeChatOpenID *string // 微信OpenID（可为空）
    Email        string
    Phone        string
    Avatar       string
    DepartmentID *uint
    Status       int     // 1-正常，0-禁用
    Roles        []Role  `gorm:"many2many:user_roles;"`
}
```

### 3.2 角色表（roles）

```go
type Role struct {
    ID          uint
    Name        string  // 角色名称
    Code        string  // 角色代码（唯一）
    Description string  // 描述
    Status      int     // 1-正常，0-禁用
    Permissions []Permission `gorm:"many2many:role_permissions;"`
}
```

### 3.3 权限表（permissions）

```go
type Permission struct {
    ID          uint
    Code        string  // 权限代码（唯一），如 "user:read"、"user:menu"
    Name        string  // 权限名称
    Resource    string  // 资源类型，如 "user"、"project"
    Action      string  // 操作类型，如 "read"、"create"、"menu"
    Description string  // 描述
    Status      int     // 1-正常，0-禁用
    
    // 菜单相关字段
    IsMenu        bool   // 是否显示在菜单中
    MenuPath      string // 菜单路径（路由路径）
    MenuIcon      string // 菜单图标
    MenuTitle     string // 菜单标题
    ParentMenuID  *uint  // 父菜单ID（用于构建多级菜单）
    MenuOrder     int    // 菜单排序
    
    Roles []Role `gorm:"many2many:role_permissions;"`
}
```

### 3.4 关联表

- **user_roles**：用户-角色关联表（多对多）
- **role_permissions**：角色-权限关联表（多对多）

## 4. 权限代码规范

### 4.1 权限代码格式

权限代码采用 `资源:操作` 的格式：

- **资源**：小写字母，如 `user`、`project`、`requirement`
- **操作**：小写字母，如 `read`、`create`、`update`、`delete`、`menu`

示例：
- `user:read` - 查看用户
- `user:create` - 创建用户
- `user:menu` - 用户管理菜单
- `requirement:read` - 查看需求
- `requirement:menu` - 需求管理菜单

### 4.2 默认权限

系统初始化时会创建以下默认权限：

**菜单权限**：
- `dashboard` - 工作台
- `project-management` - 项目管理（父菜单）
- `project:list` - 项目列表（子菜单）
- `requirement:menu` - 需求管理（子菜单）
- `task:read` - 任务管理（子菜单）
- `test-management` - 测试管理（父菜单）
- `test-case:read` - 测试单管理（子菜单）
- `bug:read` - Bug管理（子菜单）
- `version:read` - 版本管理（子菜单）
- `resource-management` - 资源管理（父菜单）
- `resource:read` - 资源统计（子菜单）
- `system-management` - 系统管理（父菜单）
- `user:menu` - 用户管理（子菜单）
- `department:read` - 部门管理（子菜单）
- `permission:manage` - 权限管理（子菜单）

**操作权限**：
- `project:read`、`project:create`、`project:update`、`project:delete`、`project:manage`
- `requirement:read`、`requirement:create`、`requirement:update`、`requirement:delete`
- `task:read`、`task:create`、`task:update`、`task:delete`
- `bug:read`、`bug:create`、`bug:update`、`bug:delete`、`bug:assign`
- `test-case:read`、`test-case:create`、`test-case:update`、`test-case:delete` - 测试单管理权限
- `user:read`、`user:create`、`user:update`、`user:delete`
- `department:read`、`department:create`、`department:update`、`department:delete`
- `permission:manage` - 权限管理（包含所有权限管理操作）
- `resource:read`、`resource:manage`
- `attachment:upload`、`attachment:delete` - 附件管理权限

### 4.3 默认角色

系统初始化时会创建以下默认角色：

- **admin**（管理员）：拥有所有权限
- **department_manager**（部门经理）：负责部门管理和项目协调
  - 拥有项目管理、需求管理、任务管理、资源管理权限
  - 拥有用户管理和部门管理权限
  - 拥有系统管理菜单权限
- **project_manager**（项目经理）：负责项目管理和任务分配
  - 拥有完整的项目管理权限（创建、更新、删除、管理）
  - 拥有需求、任务、Bug的完整管理权限
  - 拥有测试管理权限（查看测试用例、Bug管理、版本管理）
  - 拥有资源管理权限
  - 拥有用户查看权限（无用户管理菜单）
- **developer**（研发工程师）：负责开发和实现功能
  - 拥有项目查看权限
  - 拥有需求查看权限
  - 拥有任务管理权限（创建、更新）
  - 拥有测试单管理权限（查看、创建、更新）
  - 拥有Bug管理权限（查看、创建、更新、分配）
  - 无用户管理菜单权限
- **tester**（测试工程师）：负责测试和Bug管理
  - 拥有项目查看权限
  - 拥有需求查看权限
  - 拥有任务查看权限
  - 拥有完整的测试管理权限（测试单、Bug、版本的完整CRUD）
  - 无用户管理菜单权限

## 5. API 设计

### 5.1 角色管理 API

#### 获取角色列表
```
GET /api/permissions/roles
```

#### 获取角色详情
```
GET /api/permissions/roles/:id
```

#### 创建角色
```
POST /api/permissions/roles
Content-Type: application/json

{
  "name": "角色名称",
  "code": "role_code",
  "description": "角色描述",
  "status": 1
}
```

#### 更新角色
```
PUT /api/permissions/roles/:id
Content-Type: application/json

{
  "name": "角色名称",
  "code": "role_code",
  "description": "角色描述",
  "status": 1
}
```

#### 删除角色
```
DELETE /api/permissions/roles/:id
```

#### 获取角色权限
```
GET /api/permissions/roles/:id/permissions
```

#### 分配角色权限
```
POST /api/permissions/roles/:id/permissions
Content-Type: application/json

{
  "permission_ids": [1, 2, 3]
}
```

### 5.2 权限管理 API

#### 获取权限列表
```
GET /api/permissions/permissions
```

#### 获取权限详情
```
GET /api/permissions/permissions/:id
```

#### 创建权限
```
POST /api/permissions/permissions
Content-Type: application/json

{
  "code": "permission_code",
  "name": "权限名称",
  "resource": "resource_type",
  "action": "action_type",
  "description": "权限描述",
  "status": 1,
  "is_menu": false,
  "menu_path": "",
  "menu_icon": "",
  "menu_title": "",
  "parent_menu_id": null,
  "menu_order": 0
}
```

#### 更新权限
```
PUT /api/permissions/permissions/:id
Content-Type: application/json

{
  "code": "permission_code",
  "name": "权限名称",
  "resource": "resource_type",
  "action": "action_type",
  "description": "权限描述",
  "status": 1,
  "is_menu": true,
  "menu_path": "/user",
  "menu_icon": "UserOutlined",
  "menu_title": "用户管理",
  "parent_menu_id": 10,
  "menu_order": 0
}
```

#### 删除权限
```
DELETE /api/permissions/permissions/:id
```

### 5.3 用户角色管理 API

#### 获取用户角色
```
GET /api/permissions/users/:id/roles
```

#### 分配用户角色
```
POST /api/permissions/users/:id/roles
Content-Type: application/json

{
  "role_ids": [1, 2]
}
```

### 5.4 菜单管理 API

#### 获取当前用户的菜单树
```
GET /api/permissions/menus
```

**响应示例**：
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "key": "dashboard",
      "title": "工作台",
      "icon": "DashboardOutlined",
      "path": "/dashboard",
      "permission": "dashboard",
      "order": 0,
      "children": []
    },
    {
      "id": 2,
      "key": "project-management",
      "title": "项目管理",
      "icon": "ProjectOutlined",
      "path": "",
      "permission": "project-management",
      "order": 1,
      "children": [
        {
          "id": 3,
          "key": "project:list",
          "title": "项目列表",
          "icon": "",
          "path": "/project",
          "permission": "project:list",
          "order": 0,
          "children": []
        }
      ]
    }
  ]
}
```

#### 获取所有菜单树（管理员）
```
GET /api/permissions/menus/all
```

**权限要求**：`permission:manage`

### 5.5 当前用户权限 API

#### 获取当前用户的权限列表
```
GET /api/permissions/me
```

**响应示例**：
```json
{
  "code": 200,
  "message": "success",
  "data": [
    "dashboard",
    "project:read",
    "user:read",
    "user:menu"
  ]
}
```

## 6. 权限检查机制

### 6.1 认证中间件

#### Auth() 中间件

用于验证 JWT Token 并加载用户信息：

```go
func Auth() gin.HandlerFunc {
    // 1. 从请求头获取 Authorization token
    // 2. 解析 JWT Token，获取用户ID、用户名、角色列表
    // 3. 将用户信息存储到上下文（user_id, username, roles）
    // 4. 如果数据库连接存在，加载用户权限到上下文（permissions）
}
```

#### AuthWithDB() 中间件

带数据库连接的认证中间件，用于加载用户权限：

```go
func AuthWithDB(db *gorm.DB) gin.HandlerFunc {
    // 1. 验证 JWT Token
    // 2. 从数据库加载用户角色对应的权限
    // 3. 将权限列表存储到上下文
}
```

### 6.2 权限检查中间件

#### RequirePermission() 中间件

用于检查用户是否拥有特定权限：

```go
func RequirePermission(db *gorm.DB, permCode string) gin.HandlerFunc {
    // 1. 优先从上下文获取权限列表（如果已加载）
    // 2. 如果权限列表包含所需权限，允许访问
    // 3. 如果上下文没有权限列表，从角色查询
    // 4. 如果用户没有任何角色，返回 403
    // 5. 检查用户角色是否有权限
    // 6. 如果没有权限，返回 403
}
```

**使用示例**：
```go
userGroup := r.Group("/api/users", middleware.Auth())
{
    userGroup.GET("", middleware.RequirePermission(db, "user:read"), userHandler.GetUsers)
    userGroup.POST("", middleware.RequirePermission(db, "user:create"), userHandler.CreateUser)
}
```

### 6.3 权限检查流程

1. **请求到达** → `Auth()` 中间件验证 Token，加载用户信息
2. **权限检查** → `RequirePermission()` 中间件检查权限
3. **权限来源**：
   - 优先使用上下文中的权限列表（如果已加载）
   - 否则从数据库查询用户角色对应的权限
4. **权限验证**：
   - 如果用户是管理员（`admin` 角色），拥有所有权限
   - 否则检查用户角色是否包含所需权限
5. **访问控制**：
   - 有权限：继续处理请求
   - 无权限：返回 403 错误

## 7. 菜单权限控制

### 7.1 菜单加载流程

1. **前端请求**：`GET /api/permissions/menus`
2. **后端处理**：
   - 获取当前用户的角色
   - 如果是管理员，返回所有菜单权限（`is_menu = true`）
   - 否则，只返回用户有权限的菜单权限
3. **菜单构建**：
   - 根据 `parent_menu_id` 构建多级菜单树
   - 按 `menu_order` 排序
4. **前端渲染**：
   - 根据菜单树渲染导航菜单
   - 用户只能看到有权限的菜单项

### 7.2 菜单权限与操作权限分离

- **菜单权限**（如 `user:menu`）：控制菜单显示
- **操作权限**（如 `user:read`）：控制 API 访问

**设计优势**：
- 可以灵活控制菜单显示和 API 访问
- 支持只显示菜单但不允许操作，或允许操作但不显示菜单的场景
- 便于权限的细粒度管理

## 8. 初始化流程

### 8.1 默认权限初始化

系统启动时，`AutoMigrate()` 函数会调用 `initDefaultPermissionsAndRoles()` 初始化默认权限和角色：

1. **创建默认权限**：
   - 遍历 `defaultPermissions` 数组
   - 如果权限不存在，创建新权限
   - 如果权限已存在，更新菜单相关字段

2. **设置父子菜单关系**：
   - 根据 `ParentMenuID` 设置菜单的父子关系
   - 使用 `db.Model().Select("parent_menu_id").Updates()` 更新

3. **创建管理员角色**：
   - 如果 `admin` 角色不存在，创建管理员角色
   - 为管理员角色分配所有权限

### 8.2 权限更新策略

- **新增权限**：系统会自动创建新权限
- **更新权限**：保留现有 ID，只更新菜单相关字段
- **删除权限**：检查是否有角色使用，如果有则不允许删除

## 9. 安全考虑

### 9.1 权限验证

- 所有需要权限的 API 都必须使用 `RequirePermission()` 中间件
- 前端菜单隐藏只是 UI 层面的控制，真正的权限检查在后端

### 9.2 管理员权限

- 管理员（`admin` 角色）自动拥有所有权限
- 管理员可以看到所有菜单，访问所有 API

### 9.3 空角色处理

- 如果用户没有分配角色，`roles` 列表为空
- 权限检查会返回 403 错误，提示"没有权限：用户未分配角色"

### 9.4 软删除

- 用户、角色、权限都支持软删除
- 软删除的记录不会出现在查询结果中
- 但关联关系仍然保留，便于恢复

## 10. 最佳实践

### 10.1 权限命名

- 使用清晰的权限代码，如 `user:read`、`project:create`
- 菜单权限使用 `:menu` 后缀，如 `user:menu`
- 操作权限使用 `:read`、`:create`、`:update`、`:delete` 等

### 10.2 角色设计

- 创建角色时使用有意义的名称和代码
- 为角色分配最小权限集合（最小权限原则）
- 避免创建过多角色，保持角色结构清晰

### 10.3 权限分配

- 为角色分配权限时，同时分配菜单权限和对应的操作权限
- 例如：分配 `user:menu` 时，也应该分配 `user:read`、`user:create` 等

### 10.4 菜单配置

- 父菜单不设置 `menu_path`，只设置 `menu_title` 和 `menu_icon`
- 子菜单设置 `menu_path` 指向具体的路由
- 使用 `menu_order` 控制菜单显示顺序

## 11. 扩展性

### 11.1 自定义权限

系统支持通过 API 创建自定义权限，可以灵活扩展权限体系。

### 11.2 多级菜单

支持多级菜单结构，通过 `parent_menu_id` 字段实现。

### 11.3 权限继承

未来可以扩展支持权限继承，子角色可以继承父角色的权限。

## 12. 测试

### 12.1 单元测试

- 权限检查中间件的单元测试
- 权限 API 的单元测试
- 权限初始化的单元测试

### 12.2 集成测试

- 完整的权限流程测试
- 菜单权限和操作权限分离测试
- 多级菜单构建测试

## 13. 相关文档

- [数据库设计文档](./数据库设计文档.md) - 权限相关表结构
- [API设计文档](./API设计文档.md) - 权限管理 API 详细说明
- [菜单配置说明](./菜单配置说明.md) - 菜单配置使用指南

