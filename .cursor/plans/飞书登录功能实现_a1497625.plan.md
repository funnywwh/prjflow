---
name: 飞书登录功能实现
overview: 参考现有的微信登录实现，为系统添加飞书开放平台扫码登录功能。包括后端飞书客户端、API接口、数据库字段扩展、前端登录组件等完整实现。
todos:
  - id: feishu-client
    content: 创建飞书客户端包（backend/pkg/feishu/client.go），实现GetQRCode、GetAccessToken、GetUserInfo方法
    status: pending
  - id: user-model
    content: 在User模型中添加feishu_open_id字段
    status: pending
  - id: feishu-callback
    content: 创建飞书回调处理文件（backend/internal/api/feishu_callback.go），参考微信回调实现
    status: pending
    dependencies:
      - feishu-client
  - id: auth-handler-feishu
    content: 在AuthHandler中添加飞书相关方法：loadFeiShuConfig、GetFeiShuQRCode、FeiShuCallback
    status: pending
    dependencies:
      - feishu-client
      - feishu-callback
  - id: config-feishu
    content: 在配置文件中添加飞书配置结构体和默认值
    status: pending
  - id: routes-feishu
    content: 在路由配置中添加飞书登录相关路由
    status: pending
    dependencies:
      - auth-handler-feishu
  - id: frontend-api
    content: 在前端API文件（frontend/src/api/auth.ts）中添加getFeiShuQRCode函数
    status: pending
  - id: login-page
    content: 在登录页面（frontend/src/views/auth/Login.vue）中添加飞书登录标签页
    status: pending
    dependencies:
      - frontend-api
---

# 飞书登录功能实现计划

## 概述

参考现有的微信登录实现架构，为系统添加飞书开放平台扫码登录功能。实现包括后端飞书客户端封装、API接口、数据库字段扩展、前端登录组件等。

## 技术方案

### 架构设计

飞书登录流程与微信登录类似，采用OAuth2授权码模式：

1. **PC端生成二维码** → 用户扫码 → 飞书APP内授权 → 重定向到后端回调接口
2. **后端处理回调** → 使用code换取access_token → 获取用户信息 → 完成登录 → WebSocket通知PC前端
3. **PC前端接收通知** → 保存token和用户信息 → 跳转到工作台

### 数据模型

参考微信登录实现，用户表需要添加飞书OpenID字段：

- 字段名：`feishu_open_id`
- 类型：`VARCHAR(100)`，可空，唯一索引
- 用途：存储飞书用户的OpenID，用于用户识别

### 配置文件

在 `backend/internal/config/config.go` 中添加飞书配置结构：

```go
type FeiShuConfig struct {
    AppID         string `mapstructure:"app_id"`
    AppSecret     string `mapstructure:"app_secret"`
    CallbackDomain string `mapstructure:"callback_domain"`
}
```

在 `Config` 结构体中添加 `FeiShu FeiShuConfig` 字段。

## 实现步骤

### 1. 后端实现

#### 1.1 创建飞书客户端包

**文件**：`backend/pkg/feishu/client.go`参考 `backend/pkg/wechat/client.go`，创建飞书客户端：

- 实现 `GetQRCode()` 方法：生成飞书授权URL（扫码登录）
- 实现 `GetAccessToken()` 方法：使用code换取access_token
- 实现 `GetUserInfo()` 方法：使用access_token获取用户信息
- 定义接口 `FeiShuClientInterface`（类似 `WeChatClientInterface`）

**关键API端点**（基于飞书开放平台标准OAuth2流程）：

- 授权URL：`https://open.feishu.cn/open-apis/authen/v1/index?app_id={app_id}&redirect_uri={redirect_uri}&state={state}`
- 获取token：`https://open.feishu.cn/open-apis/authen/v1/oidc/access_token`
- 获取用户信息：`https://open.feishu.cn/open-apis/authen/v1/user_info`

#### 1.2 扩展用户模型

**文件**：`backend/internal/model/user.go`在 `User` 结构体中添加字段：

```go
FeiShuOpenID *string `gorm:"column:feishu_open_id;uniqueIndex;size:100" json:"feishu_open_id"`
```



#### 1.3 创建飞书回调处理（参考微信实现）

**文件**：`backend/internal/api/feishu_callback.go`参考 `backend/internal/api/wechat_callback.go`，创建：

- `FeiShuCallbackContext` 结构体
- `FeiShuCallbackHandler` 接口
- `ProcessFeiShuCallback()` 通用处理函数

**文件**：`backend/internal/api/auth.go`在 `AuthHandler` 中添加：

- `feishuClient *feishu.FeiShuClient` 字段
- `loadFeiShuConfig()` 方法（类似 `loadWeChatConfig()`）
- `GetFeiShuQRCode()` 方法（类似 `GetQRCode()`）
- `FeiShuCallback()` 方法（类似 `WeChatCallback()`）
- `LoginCallbackHandler` 适配飞书回调（复用现有逻辑，但查询 `feishu_open_id`）

#### 1.4 添加路由配置

**文件**：`backend/cmd/server/main.go`在认证路由组中添加：

```go
authGroup.GET("/feishu/qrcode", authHandler.GetFeiShuQRCode)
authGroup.GET("/feishu/callback", authHandler.FeiShuCallback)
```



### 2. 前端实现

#### 2.1 添加飞书登录API

**文件**：`frontend/src/api/auth.ts`添加函数：

```typescript
export const getFeiShuQRCode = async (): Promise<QRCodeResponse> => {
  const data: any = await request.get('/auth/feishu/qrcode')
  return {
    ticket: data.ticket || '',
    qrCodeUrl: data.qr_code_url || data.auth_url || '',
    authUrl: data.auth_url || data.qr_code_url || '',
    expireSeconds: data.expire_seconds || 600
  }
}
```



#### 2.2 更新登录页面

**文件**：`frontend/src/views/auth/Login.vue`在 `a-tabs` 中添加飞书登录标签页：

```vue
<a-tab-pane key="feishu" tab="飞书登录">
  <WeChatQRCode
    :fetchQRCode="getFeiShuQRCode"
    initial-status-text="请使用飞书扫码"
    hint="扫码后会在飞书APP内打开授权页面"
    :show-auth-url="false"
    @success="handleLoginSuccess"
  />
</a-tab-pane>
```



### 3. 数据库迁移

由于用户表添加了新字段，GORM的 `AutoMigrate` 会自动处理字段添加。对于SQLite，需要注意：

- 如果遇到NOT NULL约束问题，可能需要手动迁移
- 参考 `backend/migrations/add_wechat_open_id.sql` 的处理方式

### 4. 配置管理

**文件**：`backend/config.yaml`添加飞书配置示例：

```yaml
feishu:
  app_id: ""
  app_secret: ""
  callback_domain: "https://yourdomain.com"
```

**文件**：`backend/internal/config/config.go`在 `setDefaults()` 中添加飞书配置默认值。

### 5. 系统配置管理（可选）

如果需要在系统设置中管理飞书配置（类似微信配置管理），需要：**文件**：`backend/internal/api/system.go`（如果存在）添加获取和保存飞书配置的接口，或复用微信配置管理的逻辑。

## 注意事项

1. **API兼容性**：飞书开放平台的OAuth2流程可能与微信略有不同，需要参考飞书官方文档确认具体的API端点和参数格式。
2. **错误处理**：参考微信客户端的错误处理方式，对飞书API的错误响应进行友好提示。
3. **WebSocket复用**：飞书登录可以使用现有的WebSocket机制，无需额外修改。
4. **用户关联**：用户可以通过微信和飞书两种方式登录，两个OpenID字段是独立的，可以同时绑定。
5. **测试覆盖**：参考微信登录的测试用例，为飞书登录添加相应的单元测试。

## 待确认事项

1. 飞书开放平台的具体API端点和参数格式需要参考官方文档确认
2. 是否需要支持飞书绑定功能（类似微信绑定）？
3. 系统初始化时是否需要配置飞书（类似微信配置）？

## 参考文件

- 微信客户端实现：`backend/pkg/wechat/client.go`
- 微信回调处理：`backend/internal/api/wechat_callback.go`