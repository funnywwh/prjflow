# 数据库设计文档

## 数据库选择

- **开发环境**: SQLite
- **生产环境**: MySQL（可选）
- **ORM**: GORM（支持数据库抽象）

## 表结构设计

### 1. 用户与权限模块

#### users - 用户表

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | uint | 主键 | PRIMARY KEY |
| created_at | datetime | 创建时间 | |
| updated_at | datetime | 更新时间 | |
| deleted_at | datetime | 删除时间（软删除） | |
| wechat_open_id | varchar(100) | 微信OpenID | UNIQUE |
| username | varchar(50) | 用户名（用于登录） | NOT NULL, UNIQUE |
| nickname | varchar(50) | 昵称（用于显示） | |
| password | varchar(255) | 密码（加密存储） | |
| email | varchar(100) | 邮箱 | |
| avatar | varchar(255) | 头像URL | |
| phone | varchar(20) | 手机号 | |
| status | int | 状态（1-正常，0-禁用） | DEFAULT 1 |
| department_id | uint | 部门ID | FOREIGN KEY |

**索引**:
- `wechat_open_id` (UNIQUE)
- `username` (UNIQUE)
- `department_id`
- `deleted_at`

#### departments - 部门表

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | uint | 主键 | PRIMARY KEY |
| created_at | datetime | 创建时间 | |
| updated_at | datetime | 更新时间 | |
| deleted_at | datetime | 删除时间 | |
| name | varchar(100) | 部门名称 | NOT NULL |
| code | varchar(50) | 部门编码 | UNIQUE |
| parent_id | uint | 父部门ID | FOREIGN KEY |
| level | int | 层级 | DEFAULT 1 |
| sort | int | 排序 | DEFAULT 0 |
| status | int | 状态 | DEFAULT 1 |

**索引**:
- `code` (UNIQUE)
- `parent_id`

#### roles - 角色表

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | uint | 主键 | PRIMARY KEY |
| created_at | datetime | 创建时间 | |
| updated_at | datetime | 更新时间 | |
| deleted_at | datetime | 删除时间 | |
| name | varchar(50) | 角色名称 | NOT NULL, UNIQUE |
| code | varchar(50) | 角色代码 | NOT NULL, UNIQUE |
| description | varchar(255) | 描述 | |
| status | int | 状态 | DEFAULT 1 |

#### permissions - 权限表

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | uint | 主键 | PRIMARY KEY |
| created_at | datetime | 创建时间 | |
| updated_at | datetime | 更新时间 | |
| deleted_at | datetime | 删除时间 | |
| code | varchar(100) | 权限代码 | NOT NULL, UNIQUE |
| name | varchar(100) | 权限名称 | NOT NULL |
| resource | varchar(50) | 资源类型 | |
| action | varchar(50) | 操作类型 | |
| description | varchar(255) | 描述 | |
| status | int | 状态 | DEFAULT 1 |

#### user_roles - 用户角色关联表

| 字段名 | 类型 | 说明 |
|--------|------|------|
| user_id | uint | 用户ID |
| role_id | uint | 角色ID |

**主键**: (user_id, role_id)

#### role_permissions - 角色权限关联表

| 字段名 | 类型 | 说明 |
|--------|------|------|
| role_id | uint | 角色ID |
| permission_id | uint | 权限ID |

**主键**: (role_id, permission_id)

### 2. 项目模块

#### projects - 项目表

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | uint | 主键 |
| created_at | datetime | 创建时间 |
| updated_at | datetime | 更新时间 |
| deleted_at | datetime | 删除时间 |
| name | varchar(100) | 项目名称 |
| code | varchar(50) | 项目编码 |
| description | text | 描述 |
| status | int | 状态 |
| start_date | date | 开始日期 |
| end_date | date | 结束日期 |

**索引**: `code` (UNIQUE)

#### tags - 标签表

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | uint | 主键 |
| created_at | datetime | 创建时间 |
| updated_at | datetime | 更新时间 |
| deleted_at | datetime | 删除时间 |
| name | varchar(50) | 标签名称 |
| description | varchar(200) | 标签描述 |
| color | varchar(20) | 标签颜色 |

**索引**: `name` (UNIQUE)

#### project_tags - 项目标签关联表

| 字段名 | 类型 | 说明 |
|--------|------|------|
| project_id | uint | 项目ID |
| tag_id | uint | 标签ID |

**主键**: (project_id, tag_id)

#### project_members - 项目成员表

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | uint | 主键 |
| created_at | datetime | 创建时间 |
| updated_at | datetime | 更新时间 |
| deleted_at | datetime | 删除时间 |
| project_id | uint | 项目ID |
| user_id | uint | 用户ID |
| role | varchar(50) | 项目角色 |

**索引**: `project_id`, `user_id`

### 3. 需求与Bug模块

#### requirements - 需求表

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | uint | 主键 |
| created_at | datetime | 创建时间 |
| updated_at | datetime | 更新时间 |
| deleted_at | datetime | 删除时间 |
| title | varchar(200) | 需求标题 |
| description | text | 需求描述（Markdown） |
| status | varchar(20) | 状态（pending, in_progress, completed, cancelled） |
| priority | varchar(20) | 优先级（low, medium, high, urgent） |
| project_id | uint | 项目ID（必填） |
| creator_id | uint | 创建人ID |
| assignee_id | uint | 负责人ID（可选） |
| estimated_hours | float | 预估工时（小时） |
| actual_hours | float | 实际工时（小时，从资源分配自动计算） |

**索引**: `project_id`, `creator_id`, `assignee_id`

#### bugs - Bug表

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | uint | 主键 |
| created_at | datetime | 创建时间 |
| updated_at | datetime | 更新时间 |
| deleted_at | datetime | 删除时间 |
| title | varchar(200) | Bug标题 |
| description | text | Bug描述（Markdown） |
| status | varchar(20) | 状态（open, assigned, in_progress, resolved, closed） |
| priority | varchar(20) | 优先级（low, medium, high, urgent） |
| severity | varchar(20) | 严重程度（low, medium, high, critical） |
| project_id | uint | 项目ID（必填） |
| creator_id | uint | 创建人ID |
| requirement_id | uint | 关联需求ID（可选） |
| module_id | uint | 关联功能模块ID（可选） |
| estimated_hours | float | 预估工时（小时） |
| actual_hours | float | 实际工时（小时，从资源分配自动计算） |
| solution | varchar(50) | 解决方案（设计如此、重复Bug、外部原因、已解决、无法重现、延期处理、不予解决、转为研发需求） |
| solution_note | text | 解决方案备注 |
| resolved_version_id | uint | 解决版本ID（可选） |

**索引**: `project_id`, `creator_id`, `requirement_id`, `module_id`, `resolved_version_id`

#### bug_assignees - Bug分配表

| 字段名 | 类型 | 说明 |
|--------|------|------|
| bug_id | uint | Bug ID |
| user_id | uint | 用户ID |
| assigned_at | datetime | 分配时间 |

**主键**: (bug_id, user_id)

#### bug_assignees - Bug分配表

| 字段名 | 类型 | 说明 |
|--------|------|------|
| bug_id | uint | Bug ID |
| user_id | uint | 用户ID |
| assigned_at | datetime | 分配时间 |

**主键**: (bug_id, user_id)

### 4. 任务与看板模块

#### tasks - 任务表

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | uint | 主键 |
| created_at | datetime | 创建时间 |
| updated_at | datetime | 更新时间 |
| deleted_at | datetime | 删除时间 |
| title | varchar(200) | 任务标题 |
| description | text | 任务描述（Markdown） |
| status | varchar(20) | 状态（todo, in_progress, done, cancelled） |
| priority | varchar(20) | 优先级（low, medium, high, urgent） |
| project_id | uint | 项目ID（必填） |
| creator_id | uint | 创建人ID |
| assignee_id | uint | 负责人ID（可选） |
| requirement_id | uint | 关联需求ID（可选） |
| start_date | date | 开始日期 |
| end_date | date | 结束日期 |
| due_date | date | 截止日期 |
| progress | int | 进度（0-100） |
| estimated_hours | float | 预估工时（小时） |
| actual_hours | float | 实际工时（小时，从资源分配自动计算） |

**索引**: `project_id`, `creator_id`, `assignee_id`, `requirement_id`

#### task_dependencies - 任务依赖关系表

| 字段名 | 类型 | 说明 |
|--------|------|------|
| task_id | uint | 任务ID |
| dependency_id | uint | 依赖任务ID |
| type | varchar(20) | 依赖类型（finish_to_start, start_to_start, finish_to_finish, start_to_finish） |

**主键**: (task_id, dependency_id)

#### boards - 看板表

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | uint | 主键 |
| created_at | datetime | 创建时间 |
| updated_at | datetime | 更新时间 |
| deleted_at | datetime | 删除时间 |
| name | varchar(100) | 看板名称 |
| description | text | 描述 |
| project_id | uint | 项目ID |

#### board_columns - 看板列表

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | uint | 主键 |
| created_at | datetime | 创建时间 |
| updated_at | datetime | 更新时间 |
| deleted_at | datetime | 删除时间 |
| name | varchar(50) | 列名称 |
| color | varchar(20) | 列颜色 |
| sort | int | 排序 |
| board_id | uint | 看板ID |
| status | varchar(20) | 关联的任务状态 |

### 5. 版本模块

#### versions - 版本表

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | uint | 主键 |
| created_at | datetime | 创建时间 |
| updated_at | datetime | 更新时间 |
| deleted_at | datetime | 删除时间 |
| version_number | varchar(50) | 版本号 |
| release_notes | text | 发布说明（Markdown） |
| status | varchar(20) | 状态 |
| project_id | uint | 项目ID |
| release_date | date | 发布日期 |

**索引**: `project_id`

### 7. 测试模块

#### test_cases - 测试单表

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | uint | 主键 |
| created_at | datetime | 创建时间 |
| updated_at | datetime | 更新时间 |
| deleted_at | datetime | 删除时间 |
| name | varchar(200) | 测试单名称 |
| description | text | 测试描述 |
| test_steps | text | 测试步骤（Markdown） |
| types | text | 测试类型（JSON数组，多选：functional, performance, security等） |
| status | varchar(20) | 状态（pending, running, passed, failed） |
| result | varchar(20) | 测试结果（passed, failed, blocked，合并自TestReport） |
| summary | text | 测试摘要（合并自TestReport） |
| project_id | uint | 项目ID（必填） |
| creator_id | uint | 创建人ID |

#### test_reports - 测试报告表

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | uint | 主键 |
| created_at | datetime | 创建时间 |
| updated_at | datetime | 更新时间 |
| deleted_at | datetime | 删除时间 |
| title | varchar(200) | 报告标题 |
| content | text | 报告内容（Markdown） |
| result | varchar(20) | 测试结果 |
| summary | text | 测试摘要 |
| creator_id | uint | 创建人ID |

#### test_case_bugs - 测试单-Bug关联表

| 字段名 | 类型 | 说明 |
|--------|------|------|
| test_case_id | uint | 测试单ID |
| bug_id | uint | Bug ID |
| created_at | datetime | 创建时间 |

**主键**: (test_case_id, bug_id)

#### test_case_reports - 测试单-测试报告关联表

| 字段名 | 类型 | 说明 |
|--------|------|------|
| test_case_id | uint | 测试单ID |
| test_report_id | uint | 测试报告ID |
| created_at | datetime | 创建时间 |

**主键**: (test_case_id, test_report_id)

### 8. 资源管理模块

#### resources - 人员资源表

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | uint | 主键 |
| created_at | datetime | 创建时间 |
| updated_at | datetime | 更新时间 |
| deleted_at | datetime | 删除时间 |
| user_id | uint | 用户ID |
| project_id | uint | 项目ID |
| role | varchar(50) | 资源角色 |

**索引**: `user_id`, `project_id`

#### resource_allocations - 资源分配表（按小时）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | uint | 主键 |
| created_at | datetime | 创建时间 |
| updated_at | datetime | 更新时间 |
| deleted_at | datetime | 删除时间 |
| resource_id | uint | 资源ID（必填） |
| date | date | 日期（必填） |
| hours | float | 小时数（必填） |
| task_id | uint | 任务ID（可选） |
| bug_id | uint | Bug ID（可选） |
| requirement_id | uint | 需求ID（可选） |
| project_id | uint | 项目ID（可选） |
| description | text | 工作描述 |

**索引**: `resource_id`, `date`, `task_id`, `bug_id`, `requirement_id`, `project_id`

### 9. 工作报告模块

#### daily_reports - 日报表

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | uint | 主键 |
| created_at | datetime | 创建时间 |
| updated_at | datetime | 更新时间 |
| deleted_at | datetime | 删除时间 |
| date | date | 日期 |
| content | text | 工作内容（Markdown） |
| hours | float | 工时 |
| status | varchar(20) | 状态 |
| user_id | uint | 用户ID |
| project_id | uint | 项目ID（可选） |
| task_id | uint | 任务ID（可选） |

**索引**: `user_id`, `date` (UNIQUE复合索引: user_id, date), `project_id`, `task_id`

#### weekly_reports - 周报表

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | uint | 主键 |
| created_at | datetime | 创建时间 |
| updated_at | datetime | 更新时间 |
| deleted_at | datetime | 删除时间 |
| week_start | date | 周开始日期 |
| week_end | date | 周结束日期 |
| summary | text | 工作总结（Markdown） |
| next_week_plan | text | 下周计划（Markdown） |
| status | varchar(20) | 状态 |
| user_id | uint | 用户ID |
| project_id | uint | 项目ID（可选） |
| task_id | uint | 任务ID（可选） |

**索引**: `user_id`, `project_id`, `task_id`

### 10. 插件管理模块

#### plugins - 插件表

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | uint | 主键 |
| created_at | datetime | 创建时间 |
| updated_at | datetime | 更新时间 |
| deleted_at | datetime | 删除时间 |
| name | varchar(100) | 插件名称 |
| code | varchar(50) | 插件代码 |
| version | varchar(20) | 版本 |
| description | text | 描述 |
| path | varchar(255) | 插件路径 |
| status | varchar(20) | 状态 |
| author | varchar(100) | 作者 |
| homepage | varchar(255) | 主页 |

**索引**: `code` (UNIQUE)

#### plugin_configs - 插件配置表

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | uint | 主键 |
| created_at | datetime | 创建时间 |
| updated_at | datetime | 更新时间 |
| deleted_at | datetime | 删除时间 |
| plugin_id | uint | 插件ID |
| key | varchar(100) | 配置键 |
| value | text | 配置值 |
| type | varchar(20) | 配置类型 |

#### plugin_hooks - 插件钩子表

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | uint | 主键 |
| created_at | datetime | 创建时间 |
| updated_at | datetime | 更新时间 |
| deleted_at | datetime | 删除时间 |
| plugin_id | uint | 插件ID |
| hook_name | varchar(100) | 钩子名称 |
| handler | varchar(255) | 处理器 |
| priority | int | 优先级 |

#### plugin_routes - 插件路由表

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | uint | 主键 |
| created_at | datetime | 创建时间 |
| updated_at | datetime | 更新时间 |
| deleted_at | datetime | 删除时间 |
| plugin_id | uint | 插件ID |
| path | varchar(255) | 路由路径 |
| name | varchar(100) | 路由名称 |
| component | varchar(255) | 组件路径 |
| menu_title | varchar(100) | 菜单标题 |
| menu_icon | varchar(50) | 菜单图标 |
| menu_order | int | 菜单排序 |
| hidden | bool | 是否隐藏 |

### 11. 关系图模块

#### entity_relations - 实体关系配置表

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | uint | 主键 |
| created_at | datetime | 创建时间 |
| updated_at | datetime | 更新时间 |
| deleted_at | datetime | 删除时间 |
| name | varchar(100) | 关系名称 |
| source_type | varchar(50) | 源实体类型 |
| source_id | uint | 源实体ID |
| target_type | varchar(50) | 目标实体类型 |
| target_id | uint | 目标实体ID |
| relation_type | varchar(50) | 关系类型 |
| description | text | 描述 |

### 12. 工作台模块

#### user_dashboards - 用户工作台配置表

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | uint | 主键 |
| created_at | datetime | 创建时间 |
| updated_at | datetime | 更新时间 |
| deleted_at | datetime | 删除时间 |
| user_id | uint | 用户ID |
| config | text | JSON配置 |

**索引**: `user_id` (UNIQUE)

## 数据库关系图

### 核心关系

1. **用户-部门**: 多对一（多个用户属于一个部门）
2. **用户-角色**: 多对多（用户可以有多个角色）
3. **角色-权限**: 多对多（角色可以有多个权限）
4. **项目-需求**: 一对多（一个项目可以关联多个需求）
5. **项目-Bug**: 一对多（一个项目可以关联多个Bug）
6. **项目-任务**: 一对多（一个项目包含多个任务）
7. **项目-标签**: 多对多（一个项目可以关联多个标签，一个标签可以关联多个项目）
8. **任务-依赖**: 多对多（任务可以有多个前置依赖）
9. **版本-需求**: 多对多（一个版本可以关联多个需求）
10. **版本-Bug**: 多对多（一个版本可以关联多个Bug）
11. **测试单-Bug**: 多对多（测试单可以关联多个Bug）

## 索引策略

1. **主键索引**: 所有表都有自增主键
2. **唯一索引**: code字段（项目、部门等），name字段（标签等）
3. **外键索引**: 所有外键字段都建立索引
4. **查询索引**: 常用的查询字段（如status、created_at等）
5. **复合索引**: 多字段查询场景（如user_id + date）

## 数据迁移

使用GORM的AutoMigrate功能自动迁移数据库结构，支持：
- 自动创建表
- 自动添加字段
- 自动创建索引
- 兼容SQLite和MySQL

## 数据库兼容性

- 使用GORM抽象层，避免数据库特定语法
- 日期时间字段使用标准类型
- 文本字段使用TEXT类型（兼容性好）
- 索引创建使用GORM标签

---

**文档版本**: v1.1  
**最后更新**: 2025年11月22日

